!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-expression"),require("vega-dataflow"),require("vega-selections"),require("vega-statistics"),require("vega-util"),require("d3-array"),require("d3-color"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("d3-geo"),require("vega-scenegraph")):"function"==typeof define&&define.amd?define(["exports","vega-expression","vega-dataflow","vega-selections","vega-statistics","vega-util","d3-array","d3-color","d3-format","d3-time-format","vega-scale","d3-geo","vega-scenegraph"],e):e((t=t||self).vega={},t.vega,t.vega,t.vega,t.vega,t.vega,t.d3,t.d3,t.d3,t.d3,t.vega,t.d3,t.vega)}(this,function(t,e,n,r,o,i,a,c,u,s,l,f,d){"use strict";function g(t){const e=this.context.data[t];return e?e.values.value:[]}function m(t,e,n){const r=this.context.data[t]["index:"+e],o=r?r.value.get(n):void 0;return o?o.count:o}function p(t,e){const n=this.context.dataflow,r=this.context.data[t].input;return n.pulse(r,n.changeset().remove(i.truthy).insert(e)),1}function h(t,e,n){if(t){const n=this.context.dataflow,r=t.mark.source;n.pulse(r,n.changeset().encode(t,e))}return void 0!==n?n:t}const v={};function y(t,e,n){let r=t+":"+n,o=v[r];return o&&o[0]===e||(v[r]=o=[e,e(n)]),o[1]}function x(t,e){return y("format",u.format,e)(t)}function b(t,e){return y("timeFormat",s.timeFormat,e)(t)}function w(t,e){return y("utcFormat",s.utcFormat,e)(t)}function P(t,e){return y("timeParse",s.timeParse,e)(t)}function S(t,e){return y("utcParse",s.utcParse,e)(t)}var F=new Date(2e3,0,1);function q(t,e,n){return F.setMonth(t),F.setDate(e),b(F,n)}function A(t){return q(t,1,"%B")}function L(t){return q(t,1,"%b")}function k(t){return q(0,2+t,"%A")}function D(t){return q(0,2+t,"%a")}function z(t,e){let n;return i.isFunction(t)?t:i.isString(t)?(n=e.scales[t])&&n.value:void 0}function R(t,e){const n=z(t,(e||this).context);return n&&n.range?n.range():[]}function B(t,e){const n=z(t,(e||this).context);return n?n.domain():[]}function O(t,e){const n=z(t,(e||this).context);return n&&n.bandwidth?n.bandwidth():0}function E(t,e,n){return l.bandSpace(t||0,e||0,n||0)}function V(t,e){const n=z(t,(e||this).context);return n?n.copy():void 0}function j(t,e,n){const r=z(t,(n||this).context);return r&&void 0!==e?r(e):void 0}function N(t,e,n){const r=z(t,(n||this).context);return r?i.isArray(e)?(r.invertRange||r.invert)(e):(r.invert||r.invertExtent)(e):void 0}function T(t,e){return function(n,r,o){if(n){const e=z(n,(o||this).context);return e&&e.path[t](r)}return e(r)}}const X=T("area",f.geoArea),_=T("bounds",f.geoBounds),C=T("centroid",f.geoCentroid);function M(t){let e=this.context.group,n=!1;if(e)for(;t;){if(t===e){n=!0;break}t=t.mark.group}return n}function Y(t,e,n){try{t[e].apply(t,["EXPRESSION"].concat([].slice.call(n)))}catch(e){t.warn(e)}return n[n.length-1]}function G(){return Y(this.context.dataflow,"warn",arguments)}function I(){return Y(this.context.dataflow,"info",arguments)}function H(){return Y(this.context.dataflow,"debug",arguments)}function W(){var t=[].slice.call(arguments);return t.unshift({}),i.extend.apply(null,t)}function $(t,e){return t===e||t!=t&&e!=e||!(!i.isArray(t)||!i.isArray(e)||t.length!==e.length)&&function(t,e){for(let n=0,r=t.length;n<r;++n)if(!$(t[n],e[n]))return!1;return!0}(t,e)}function J(t){return function(e){for(let n in t)if(!$(e[n],t[n]))return!1;return!0}}function K(t,e,r,o,a,c){let u,s,l=this.context.dataflow,f=this.context.data[t],d=f.input,g=f.changes,m=l.stamp();if(!1===l._trigger||!(d.value.length||e||o))return 0;if((!g||g.stamp<m)&&(f.changes=g=l.changeset(),g.stamp=m,l.runAfter(function(){f.modified=!0,l.pulse(d,g).run()},!0,1)),r&&(u=!0===r?i.truthy:i.isArray(r)||n.isTuple(r)?r:J(r),g.remove(u)),e&&g.insert(e),o&&(u=J(o),d.value.some(u)?g.remove(u):g.insert(o)),a)for(s in c)g.modify(a,s,c[s]);return 1}function Q(t){const e=t.touches,n=e[0].clientX-e[1].clientX,r=e[0].clientY-e[1].clientY;return Math.sqrt(n*n+r*r)}function U(t){const e=t.touches;return Math.atan2(e[0].clientY-e[1].clientY,e[0].clientX-e[1].clientX)}function Z(t,e,n,r,o){t=z(t,(o||this).context);const a=d.Gradient(e,n);let c=t.domain(),u=c[0],s=i.peek(c),f=i.identity;return s-u?f=l.scaleFraction(t,u,s):t=(t.interpolator?l.scale("sequential")().interpolator(t.interpolator()):l.scale("linear")().interpolate(t.interpolate()).range(t.range())).domain([u=0,s=1]),t.ticks&&(u!==(c=t.ticks(+r||15))[0]&&c.unshift(u),s!==i.peek(c)&&c.push(s)),c.forEach(e=>a.stop(f(e),t(e))),a}function tt(t,e,n){const r=z(t,(n||this).context);return function(t){return r?r.path.context(t)(e):""}}function et(t){let e=null;return function(n){return n?d.pathRender(n,e=e||d.pathParse(t)):t}}const nt={};function rt(t){return t.data}function ot(t,e){const n=g.call(e,t);return n.root&&n.root.lookup||nt}function it(t,e,n){const r=ot(t,this),o=r[e],i=r[n];return o&&i?o.path(i).map(rt):void 0}function at(t,e){const n=ot(t,this)[e];return n?n.ancestors().map(rt):void 0}const ct="undefined"!=typeof window&&window||null;function ut(){return ct?ct.screen:{}}function st(){return ct?[ct.innerWidth,ct.innerHeight]:[void 0,void 0]}function lt(){const t=this.context.dataflow,e=t.container&&t.container();return e?[e.clientWidth,e.clientHeight]:[void 0,void 0]}const ft=":",dt="@",gt="%";function mt(t,n,r,o){n[0].type!==e.Literal&&i.error("First argument to data functions must be a string literal.");const a=n[0].value,c=ft+a;o.hasOwnProperty(c)||(o[c]=r.getData(a).tuplesRef())}function pt(t,n,r,o){n[0].type!==e.Literal&&i.error("First argument to indata must be a string literal."),n[1].type!==e.Literal&&i.error("Second argument to indata must be a string literal.");const a=n[0].value,c=n[1].value,u=dt+c;o.hasOwnProperty(u)||(o[u]=r.getData(a).indataRef(r,c))}function ht(t,n,r,o){if(n[0].type===e.Literal)vt(r,o,n[0].value);else if(n[0].type===e.Identifier)for(t in r.scales)vt(r,o,t)}function vt(t,e,n){const r=gt+n;if(!e.hasOwnProperty(r))try{e[r]=t.scaleRef(n)}catch(t){}}const yt={random:function(){return o.random()},isArray:i.isArray,isBoolean:i.isBoolean,isDate:i.isDate,isDefined:function(t){return void 0!==t},isNumber:i.isNumber,isObject:i.isObject,isRegExp:i.isRegExp,isString:i.isString,isTuple:n.isTuple,isValid:function(t){return null!=t&&t==t},toBoolean:i.toBoolean,toDate:i.toDate,toNumber:i.toNumber,toString:i.toString,flush:i.flush,lerp:i.lerp,merge:W,pad:i.pad,peek:i.peek,span:i.span,inrange:i.inrange,truncate:i.truncate,rgb:c.rgb,lab:c.lab,hcl:c.hcl,hsl:c.hsl,sequence:a.range,format:x,utcFormat:w,utcParse:S,timeFormat:b,timeParse:P,monthFormat:A,monthAbbrevFormat:L,dayFormat:k,dayAbbrevFormat:D,quarter:i.quarter,utcquarter:i.utcquarter,warn:G,info:I,debug:H,extent:i.extent,inScope:M,intersect:function(t,e,n){if(!t)return[];const[r,o]=t,a=(new d.Bounds).set(r[0],r[1],o[0],o[1]),c=n||this.context.dataflow.scenegraph().root;return d.intersect(c,a,function(t){let e=null;if(t){const n=i.array(t.marktype),r=i.array(t.markname);e=(t=>(!n.length||n.some(e=>t.marktype===e))&&(!r.length||r.some(e=>t.name===e)))}return e}(e))},clampRange:i.clampRange,pinchDistance:Q,pinchAngle:U,screen:ut,containerSize:lt,windowSize:st,bandspace:E,setdata:p,pathShape:et,panLinear:i.panLinear,panLog:i.panLog,panPow:i.panPow,panSymlog:i.panSymlog,zoomLinear:i.zoomLinear,zoomLog:i.zoomLog,zoomPow:i.zoomPow,zoomSymlog:i.zoomSymlog,encode:h,modify:K},xt=["view","item","group","xy","x","y"],bt="event.vega.",wt="this.",Pt={};function St(t,e,n){return 1===arguments.length?yt[t]:(yt[t]=e,n&&(Pt[t]=n),qt&&(qt.functions[t]=wt+t),this)}St("bandwidth",O,ht),St("copy",V,ht),St("domain",B,ht),St("range",R,ht),St("invert",N,ht),St("scale",j,ht),St("gradient",Z,ht),St("geoArea",X,ht),St("geoBounds",_,ht),St("geoCentroid",C,ht),St("geoShape",tt,ht),St("indata",m,pt),St("data",g,mt),St("treePath",it,mt),St("treeAncestors",at,mt),St("vlSelectionTest",r.selectionTest,r.selectionVisitor),St("vlSelectionResolve",r.selectionResolve,r.selectionVisitor);const Ft={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(t){return"_["+i.stringValue("$"+t)+"]"},functions:function(t){const n=e.functions(t);xt.forEach(t=>n[t]=bt+t);for(let t in yt)n[t]=wt+t;return n},constants:e.constants,visitors:Pt};var qt=e.codegen(Ft);Object.defineProperty(t,"formatLocale",{enumerable:!0,get:function(){return u.formatDefaultLocale}}),Object.defineProperty(t,"timeFormatLocale",{enumerable:!0,get:function(){return s.timeFormatDefaultLocale}}),t.DataPrefix=ft,t.IndexPrefix=dt,t.ScalePrefix=gt,t.SignalPrefix="$",t.bandspace=E,t.bandwidth=O,t.codeGenerator=qt,t.codegenParams=Ft,t.containerSize=lt,t.copy=V,t.data=g,t.dataVisitor=mt,t.dayAbbrevFormat=D,t.dayFormat=k,t.debug=H,t.domain=B,t.encode=h,t.expressionFunction=St,t.format=x,t.functionContext=yt,t.geoArea=X,t.geoBounds=_,t.geoCentroid=C,t.geoShape=tt,t.inScope=M,t.indata=m,t.indataVisitor=pt,t.info=I,t.invert=N,t.merge=W,t.modify=K,t.monthAbbrevFormat=L,t.monthFormat=A,t.pathShape=et,t.pinchAngle=U,t.pinchDistance=Q,t.range=R,t.scale=j,t.scaleGradient=Z,t.scaleVisitor=ht,t.screen=ut,t.setdata=p,t.timeFormat=b,t.timeParse=P,t.treeAncestors=at,t.treePath=it,t.utcFormat=w,t.utcParse=S,t.warn=G,t.windowSize=st,Object.defineProperty(t,"__esModule",{value:!0})});