"use strict";var _this=void 0,_arguments=arguments;exports.__esModule=!0,exports.default=void 0;var _d=_interopRequireDefault(require("d3")),_propTypes=_interopRequireDefault(require("prop-types")),_d3Hierarchy=require("d3-hierarchy"),_color=require("@superset-ui/color"),_numberFormat=require("@superset-ui/number-format"),_timeFormat=require("@superset-ui/time-format");require("./Partition.css");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}// Compute dx, dy, x, y for each node and
// return an array of nodes in breadth-first order
function init(a){var b=[],c=1/(a.height+1),d=null;return a.each(function(a){a.y=c*a.depth,a.dy=c,a.parent?(a.x=d.depth===a.parent.depth?0:d.x+d.dx,a.dx=a.weight/a.parent.sum*a.parent.dx):(a.x=0,a.dx=1),d=a,b.push(a)}),b}// Declare PropTypes for recursive data structures
// https://github.com/facebook/react/issues/5676
/* eslint-disable-next-line  no-undef */var lazyFunction=function(a){return function(){return a().apply(_this,_arguments)}},leafType=_propTypes.default.shape({name:_propTypes.default.string,val:_propTypes.default.number.isRequired}),parentShape={name:_propTypes.default.string,val:_propTypes.default.number.isRequired,children:_propTypes.default.arrayOf(_propTypes.default.oneOfType([_propTypes.default.shape(lazyFunction(function(){return parentShape})),leafType]))},nodeType=_propTypes.default.oneOfType([_propTypes.default.shape(parentShape),leafType]),propTypes={data:_propTypes.default.arrayOf(nodeType),// array of rootNode
width:_propTypes.default.number,height:_propTypes.default.number,colorScheme:_propTypes.default.string,dateTimeFormat:_propTypes.default.string,equalDateSize:_propTypes.default.bool,levels:_propTypes.default.arrayOf(_propTypes.default.string),metrics:_propTypes.default.arrayOf(_propTypes.default.oneOfType([_propTypes.default.string,_propTypes.default.object])),numberFormat:_propTypes.default.string,partitionLimit:_propTypes.default.number,partitionThreshold:_propTypes.default.number,timeSeriesOption:_propTypes.default.string,useLogScale:_propTypes.default.bool,useRichTooltip:_propTypes.default.bool};// This vis is based on
// http://mbostock.github.io/d3/talk/20111018/partition.html
function Icicle(a,b){function c(b,c){function i(a){return 0<=q.indexOf(a.data.name)&&A}// node.name is the metric/group name
// node.disp is the display value
// node.value determines sorting order
// node.weight determines partition height
// node.sum is the sum of children weights
function j(a){return a?A&&1===a?"Date":l[a-(A?2:1)]:"Metric"}function m(a){for(var b=[a],c=a;c.parent;)b.push(c.parent),c=c.parent;return b}function n(b,c){var d="<table>";if(u){var h=m(c);h.reverse().forEach(function(a){var b=a.depth===c.depth;d+="<tbody>",d+="<tr>"+"<td>"+"<div "+("style='border: 2px solid "+(b?"black":"transparent")+";")+("background-color: "+a.color+";'")+"></div>"+"</td>"+("<td>"+j(a.depth)+"</td>")+("<td>"+a.name+"</td>")+("<td>"+a.disp+"</td>")+"</tr>"})}else d+="<thead><tr><td colspan=\"3\">"+("<strong>"+j(c.depth)+"</strong>")+"</td></tr></thead><tbody>",d+="<tr>"+"<td>"+("<div style='border: thin solid grey; background-color: "+c.color+";'")+"></div>"+"</td>"+("<td>"+c.name+"</td>")+("<td>"+c.disp+"</td>")+"</tr>";d+="</tbody></table>";var e=_d.default.mouse(a),f=e[0],g=e[1];b.html(d).style("left",f+15+"px").style("top",g+"px")}// Keep text centered in its division
function p(a){return"translate(8,"+a.dx*J/2+")"}// When clicking a subdivision, the vis will zoom in to it
function r(a){if(!a.children)return!!a.parent&&r(a.parent);I=(a.y?F-40:F)/(1-a.y),J=w/a.dx,h.domain([a.y,1]).range([a.y?40:0,F]),x.domain([a.x,a.x+a.dx]);var b=K.transition().duration(_d.default.event.altKey?7500:750).attr("transform",function(a){return"translate("+h(a.y)+","+x(a.x)+")"});return b.select("rect").attr("width",a.dy*I).attr("height",function(a){return a.dx*J}),b.select("text").attr("transform",p).style("opacity",function(a){return 12<a.dx*J?1:0}),_d.default.event.stopPropagation(),!0}var v=c[b],F=d,w=e/f.length,h=_d.default.scale.linear().range([0,F]),x=_d.default.scale.linear().range([0,w]),y=z.append("div").attr("class","chart").style("width",F+"px").style("height",w+"px").append("svg:svg").attr("width",F).attr("height",w);b!==f.length-1&&1<f.length&&y.style("padding-bottom","3px"),0!==b&&1<f.length&&y.style("padding-top","3px");var G=(0,_d3Hierarchy.hierarchy)(v);G.eachAfter(function(a){a.disp=a.data.val,a.value=0>a.disp?-a.disp:a.disp,a.weight=a.value,a.name=a.data.name,a.parent&&i(a.parent)&&(a.weight=k?1:a.value,a.value=a.name,a.name=C(a.name)),o&&(a.weight=Math.log(a.weight+1)),a.disp=a.disp&&!Number.isNaN(a.disp)&&Number.isFinite(a.disp)?B(a.disp):""}),G.sort(function(c,a){var b=a.value-c.value;return 0==b?a.name>c.name?1:-1:b}),t&&0<=t&&G.each(function(a){if(a.sum=a.children?a.children.reduce(function(b,a){return b+a.weight},0)||1:1,a.children)// Dates are not ordered by weight
if(i(a)){if(k)return;// Keep at least one child
for(var b=[],c=1;c<a.children.length;c++)a.children[c].weight/a.sum<t&&b.push(c);for(var d=b.length-1;0<=d;d--)a.children.splice(b[d],1)}else{// Find first child that falls below the threshold
var e;for(e=1;e<a.children.length&&!(a.children[e].weight/a.sum<t);e++);a.children=a.children.slice(0,e)}}),s&&0<=s&&G.each(function(a){a.children&&a.children.length>s&&!i(a)&&(a.children=a.children.slice(0,s))}),G.eachAfter(function(a){a.sum=a.children?a.children.reduce(function(b,a){return b+a.weight},0)||1:1});var H=init(G),I=F/G.dx,J=w/1,K=y.selectAll("g").data(H).enter().append("svg:g").attr("transform",function(a){return"translate("+h(a.y)+","+x(a.x)+")"}).on("mouseover",function(a){E.interrupt().transition().duration(100).style("opacity",.9),n(E,a)}).on("mousemove",function(a){n(E,a)}).on("mouseout",function(){E.interrupt().transition().duration(250).style("opacity",0)});// Apply color scheme
K.on("click",r),K.append("svg:rect").attr("width",G.dy*I).attr("height",function(a){return a.dx*J}),K.append("svg:text").attr("transform",p).attr("dy","0.35em").style("opacity",function(a){return 12<a.dx*J?1:0}).text(function(a){return a.disp?a.name+": "+a.disp:a.name}),K.selectAll("rect").style("fill",function(a){return a.color=D(a.name),a.color})}var d=b.width,e=b.height,f=b.data,g=b.colorScheme,h=b.dateTimeFormat,k=b.equalDateSize,l=b.levels,m=b.useLogScale,o=void 0!==m&&m,p=b.metrics,q=void 0===p?[]:p,r=b.numberFormat,s=b.partitionLimit,t=b.partitionThreshold,u=b.useRichTooltip,v=b.timeSeriesOption,w=void 0===v?"not_time":v,z=_d.default.select(a);z.classed("superset-legacy-chart-partition",!0);// Chart options
var A=0<=["adv_anal","time_series"].indexOf(w),B=(0,_numberFormat.getNumberFormatter)(r),C=(0,_timeFormat.getTimeFormatter)(h),D=_color.CategoricalColorNamespace.getScale(g);z.selectAll("*").remove();for(var E=z.append("div").classed("partition-tooltip",!0),F=0;F<f.length;F++)c(F,f)}Icicle.displayName="Icicle",Icicle.propTypes=propTypes;var _default=Icicle;exports.default=_default;