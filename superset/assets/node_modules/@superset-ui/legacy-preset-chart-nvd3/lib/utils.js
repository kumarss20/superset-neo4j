"use strict";exports.__esModule=!0,exports.cleanColorInput=cleanColorInput,exports.getTimeOrNumberFormatter=getTimeOrNumberFormatter,exports.drawBarValues=drawBarValues,exports.generateRichLineTooltipContent=generateRichLineTooltipContent,exports.generateAreaChartTooltipContent=generateAreaChartTooltipContent,exports.generateMultiLineTooltipContent=generateMultiLineTooltipContent,exports.generateTimePivotTooltip=generateTimePivotTooltip,exports.generateBubbleTooltipContent=generateBubbleTooltipContent,exports.hideTooltips=hideTooltips,exports.generateTooltipClassName=generateTooltipClassName,exports.removeTooltip=removeTooltip,exports.wrapTooltip=wrapTooltip,exports.tipFactory=tipFactory,exports.getMaxLabelSize=getMaxLabelSize,exports.formatLabel=formatLabel,exports.computeBarChartWidth=computeBarChartWidth,exports.tryNumify=tryNumify,exports.stringifyTimeRange=stringifyTimeRange,exports.setAxisShowMaxMin=setAxisShowMaxMin,exports.computeYDomain=computeYDomain,exports.computeStackedYDomain=computeStackedYDomain;var _d=_interopRequireDefault(require("d3")),_d3Tip=_interopRequireDefault(require("d3-tip")),_dompurify=_interopRequireDefault(require("dompurify")),_numberFormat=require("@superset-ui/number-format"),_timeFormat=require("@superset-ui/time-format");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */ /* eslint-disable babel/no-invalid-this, no-magic-numbers */ // Regexp for the label added to time shifted series
// (1 hour offset, 2 days offset, etc.)
var TIME_SHIFT_PATTERN=/\d+ \w+ offset/,ANIMATION_TIME=1e3;function cleanColorInput(a){// for superset series that should have the same color
return(a+"").trim().replace(" (right axis)","").split(", ").filter(function(a){return!TIME_SHIFT_PATTERN.test(a)}).join(", ")}/**
 * If format is smart_date, format date
 * Otherwise, format number with the given format name
 * @param {*} format
 */function getTimeOrNumberFormatter(a){return"smart_date"===a?_timeFormat.smartDateFormatter:(0,_numberFormat.getNumberFormatter)(a)}function drawBarValues(a,b,c,d){var e=(0,_numberFormat.getNumberFormatter)(d),f=b.filter(function(a){return!a.disabled}).length,g=c&&0!==b.length?b[0].values.map(function(a,c){var d=b.filter(function(a){return!a.disabled}).map(function(a){return a.values[c]});return _d.default.sum(d,function(a){return a.y})}):[];a.selectAll(".bar-chart-label-group").remove(),setTimeout(function(){var b=a.select("g.nv-barsWrap").append("g").attr("class","bar-chart-label-group");a.selectAll("g.nv-group").filter(function(a,b){return!c||b===f-1}).selectAll("rect").each(function(a,d){var f=_d.default.select(this),h=f.attr("transform"),i=parseFloat(f.attr("x")),j=parseFloat(f.attr("y")),k=parseFloat(f.attr("width")),l=parseFloat(f.attr("height")),m=b.append("text").text(e(c?g[d]:a.y)).attr("transform",h).attr("class","bar-chart-label"),n=m.node().getBBox(),o=n.width,p=n.height;m.attr("x",i+k/2-o/2),f.attr("class").includes("positive")?m.attr("y",j-5):m.attr("y",j+l+p)})},ANIMATION_TIME)}// Formats the series key to account for a possible NULL value
function getFormattedKey(a,b){return"<NULL>"===a?"&lt;"+a.slice(1,-1)+"&gt;":b?_dompurify.default.sanitize(a):a}// Custom sorted tooltip
// use a verbose formatter for times
function generateRichLineTooltipContent(a,b,c){var d="";return d+="<table><thead><tr><td colspan='3'>"+("<strong class='x-value'>"+b(a.value)+"</strong>")+"</td></tr></thead><tbody>",a.series.sort(function(c,a){return c.value>=a.value?-1:1}),a.series.forEach(function(a){var b=getFormattedKey(a.key,!0);d+="<tr class=\""+(a.highlight?"emph":"")+"\">"+("<td class='legend-color-guide' style=\"opacity: "+(a.highlight?"1":"0.75")+";\"\">")+"<div "+("style=\"border: 2px solid "+(a.highlight?"black":"transparent")+"; background-color: "+a.color+";\"")+"></div>"+"</td>"+("<td>"+b+"</td>")+("<td>"+c(a.value)+"</td>")+"</tr>"}),d+="</tbody></table>",_dompurify.default.sanitize(d)}function generateAreaChartTooltipContent(a,b,c){var d=a.series[a.series.length-1].value,e="";return e+="<table><thead><tr><td colspan='4'>"+("<strong class='x-value'>"+b(a.value)+"</strong>")+"</td></tr></thead><tbody>"+"<tr><td></td><td>Category</td><td>Value</td><td>% to total</td></tr>",a.series.forEach(function(a){var b=getFormattedKey(a.key,!0),f="";a.highlight?f="superset-legacy-chart-nvd3-tr-highlight":"TOTAL"===a.key&&(f="superset-legacy-chart-nvd3-tr-total"),e+="<tr class=\""+f+"\" style=\"border-color: "+a.color+"\">"+("<td style=\"color: "+a.color+"\">"+("TOTAL"===a.key?"":"&#9724;")+"</td>")+("<td>"+b+"</td>")+("<td>"+c(a.value)+"</td>")+("<td>"+(100*a.value/d).toFixed(2)+"%</td>")+"</tr>"}),e+="</tbody></table>",_dompurify.default.sanitize(e)}function generateMultiLineTooltipContent(a,b,c){var d=b(a.value),e="";return e+="<table><thead><tr><td colspan='3'>"+("<strong class='x-value'>"+d+"</strong>")+"</td></tr></thead><tbody>",a.series.forEach(function(a,b){var d=c[b],f=getFormattedKey(a.key,!1);e+="<tr><td class='legend-color-guide'>"+("<div style=\"background-color: "+a.color+";\"></div></td>")+("<td class='key'>"+f+"</td>")+("<td class='value'>"+d(a.value)+"</td></tr>")}),e+="</tbody></table>",e}function generateTimePivotTooltip(a,b,c){var d=b(a.value),e="";return e+="<table><thead><tr><td colspan='3'>"+("<strong class='x-value'>"+d+"</strong>")+"</td></tr></thead><tbody>",a.series.forEach(function(a){if(a.highlight){var b="";b="current"===a.key?a.key:a.key+" of the selected frequency:",e+="<tr><td class='legend-color-guide'>"+("<div style=\"background-color: "+a.color+";\"></div></td>")+("<td class='key'>"+b+"</td>")+("<td class='value'>"+c(a.value)+"</td></tr>")}}),e+="</tbody></table>",_dompurify.default.sanitize(e)}function getLabel(a){return a.label||a}function createHTMLRow(a,b){return"<tr><td>"+a+"</td><td>"+b+"</td></tr>"}function generateBubbleTooltipContent(a){var b=a.point,c=a.entity,d=a.xField,e=a.yField,f=a.sizeField,g=a.xFormatter,h=a.yFormatter,i=a.sizeFormatter,j="<table>";return j+="<tr><td style=\"color: "+b.color+";\">"+("<strong>"+b[c]+"</strong> ("+b.group+")")+"</td></tr>",j+=createHTMLRow(getLabel(d),g(b.x)),j+=createHTMLRow(getLabel(e),h(b.y)),j+=createHTMLRow(getLabel(f),i(b.size)),j+="</table>",j}// shouldRemove indicates whether the nvtooltips should be removed from the DOM
function hideTooltips(a){var b=document.querySelectorAll(".nvtooltip");0<b.length&&b.forEach(function(b){a?b.remove():b.style.opacity=0})}function generateTooltipClassName(a){return"tooltip-"+a}function removeTooltip(a){var b="."+generateTooltipClassName(a),c=document.querySelector(b);c&&c.remove()}function wrapTooltip(a,b){var c=a.useInteractiveGuideline&&a.useInteractiveGuideline()?a.interactiveLayer:a,e=c.tooltip.contentGenerator();c.tooltip.contentGenerator(function(a){var c="<div style=\"max-width: "+.5*b+"px\">";return c+=e(a),c+="</div>",c})}function tipFactory(a){return(0,_d3Tip.default)().attr("class","d3-tip").direction("n").offset([-5,0]).html(function(b){if(!b)return"";var c=b[a.titleColumn]&&b[a.titleColumn].length?b[a.titleColumn]+" - "+a.name:a.name,d=Array.isArray(a.descriptionColumns)?a.descriptionColumns.map(function(a){return b[a]}):/* eslint-disable-next-line compat/compat */Object.values(b);return"<div><strong>"+c+"</strong></div><br/><div>"+d.join(", ")+"</div>"})}function getMaxLabelSize(a,b){// axis class = .nv-y2  // second y axis on dual line chart
// axis class = .nv-x  // x axis on time series line chart
var c=a.selectAll("."+b+" g.tick text");if(0<c.length){var d=c[0].map(function(a){return a.getComputedTextLength()});return Math.ceil(Math.max.apply(Math,[0].concat(d)))}return 0}function formatLabel(a,b){void 0===b&&(b={});// The input for label may be a string or an array of string
// When using the time shift feature, the label contains a '---' in the array
var c=function(a){return b[a]||a};return Array.isArray(a)&&a.length?a.map(function(a){return TIME_SHIFT_PATTERN.test(a)?a:c(a)}).join(", "):c(a)}var MIN_BAR_WIDTH=18;function computeBarChartWidth(a,b,c){var d=b?_d.default.max(a,function(a){return a.values.length}):_d.default.sum(a,function(a){return a.values.length});return Math.max(d*MIN_BAR_WIDTH,c)}function tryNumify(a){// Attempts casting to Number, returns string when failing
var b=+a;return Number.isNaN(b)?a:b}function stringifyTimeRange(a){return a.some(function(a){return void 0===a.toISOString})?null:a.map(function(a){return a.toISOString().slice(0,-1)}).join(" : ")}function setAxisShowMaxMin(a,b){a&&a.showMaxMin&&b!==void 0&&a.showMaxMin(b)}function computeYDomain(a){if(Array.isArray(a)&&0<a.length&&Array.isArray(a[0].values)){var b=a.filter(function(a){return!a.disabled}).map(function(a){return _d.default.extent(a.values,function(a){return a.y})}),c=_d.default.min(b,function(a){var b=a[0];return b}),d=_d.default.max(b,function(a){var b=a[1];return b});return[c,d]}return[0,1]}function computeStackedYDomain(a){if(Array.isArray(a)&&0<a.length&&Array.isArray(a[0].values)){var b=a.filter(function(a){return!a.disabled}).map(function(a){return a.values.map(function(a){return a.y})}),c=b[0].map(function(a,c){return b.reduce(function(a,b){return a+b[c]},0)});return[Math.min.apply(Math,[0].concat(c)),Math.max.apply(Math,[0].concat(c))]}return[0,1]}