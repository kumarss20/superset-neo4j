"use strict";exports.__esModule=!0,exports.default=void 0;var _lodash=require("lodash"),_d=_interopRequireDefault(require("d3")),_nvd=_interopRequireDefault(require("nvd3")),_mathjs=_interopRequireDefault(require("mathjs")),_moment=_interopRequireDefault(require("moment")),_propTypes=_interopRequireDefault(require("prop-types")),_core=require("@superset-ui/core"),_translation=require("@superset-ui/translation"),_color=require("@superset-ui/color"),_numberFormat=require("@superset-ui/number-format"),_timeFormat=require("@superset-ui/time-format");require("nvd3/build/nv.d3.min.css");var _AnnotationTypes=_interopRequireWildcard(require("./vendor/superset/AnnotationTypes")),_isTruthy=_interopRequireDefault(require("./utils/isTruthy")),_utils=require("./utils"),_PropTypes=require("./PropTypes");require("./NVD3Vis.css");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;return _getRequireWildcardCache=function(){return a},a}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var b=_getRequireWildcardCache();if(b&&b.has(a))return b.get(a);var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a)if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;f&&(f.get||f.set)?Object.defineProperty(c,e,f):c[e]=a[e]}return c.default=a,b&&b.set(a,c),c}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}var getColor=_color.CategoricalColorNamespace.getColor,getScale=_color.CategoricalColorNamespace.getScale,MAX_MARGIN_PAD=30,MIN_HEIGHT_FOR_BRUSH=480,MAX_NO_CHARACTERS_IN_LABEL=40,BREAKPOINTS={small:340},TIMESERIES_VIZ_TYPES=["line","dual_line","line_multi","area","compare","bar","time_pivot"],propTypes={data:_propTypes.default.oneOfType([_propTypes.default.arrayOf(_propTypes.default.oneOfType([// pie
_PropTypes.categoryAndValueXYType,// dist-bar
_propTypes.default.shape({key:_propTypes.default.string,values:_propTypes.default.arrayOf(_PropTypes.categoryAndValueXYType)}),// area, line, compare, bar
_propTypes.default.shape({key:_propTypes.default.arrayOf(_propTypes.default.string),values:_propTypes.default.arrayOf(_PropTypes.numericXYType)}),// dual-line
_propTypes.default.shape({classed:_propTypes.default.string,key:_propTypes.default.string,type:_propTypes.default.string,values:_propTypes.default.arrayOf(_PropTypes.numericXYType),yAxis:_propTypes.default.number}),// box-plot
_propTypes.default.shape({label:_propTypes.default.string,values:_propTypes.default.arrayOf(_PropTypes.boxPlotValueType)}),// bubble
_propTypes.default.shape({key:_propTypes.default.string,values:_propTypes.default.arrayOf(_propTypes.default.object)})])),// bullet
_PropTypes.bulletDataType]),width:_propTypes.default.number,height:_propTypes.default.number,annotationData:_propTypes.default.object,annotationLayers:_propTypes.default.arrayOf(_PropTypes.annotationLayerType),bottomMargin:_PropTypes.numberOrAutoType,colorScheme:_propTypes.default.string,comparisonType:_propTypes.default.string,contribution:_propTypes.default.bool,leftMargin:_PropTypes.numberOrAutoType,onError:_propTypes.default.func,showLegend:_propTypes.default.bool,showMarkers:_propTypes.default.bool,useRichTooltip:_propTypes.default.bool,vizType:_propTypes.default.oneOf(["area","bar","box_plot","bubble","bullet","compare","column","dist_bar","line","line_multi","time_pivot","pie","dual_line"]),xAxisFormat:_propTypes.default.string,numberFormat:_propTypes.default.string,xAxisLabel:_propTypes.default.string,xAxisShowMinMax:_propTypes.default.bool,xIsLogScale:_propTypes.default.bool,xTicksLayout:_propTypes.default.oneOf(["auto","staggered","45\xB0"]),yAxisFormat:_propTypes.default.string,yAxisBounds:_propTypes.default.arrayOf(_propTypes.default.number),yAxisLabel:_propTypes.default.string,yAxisShowMinMax:_propTypes.default.bool,yIsLogScale:_propTypes.default.bool,// 'dist-bar' only
orderBars:_propTypes.default.bool,// 'bar' or 'dist-bar'
isBarStacked:_propTypes.default.bool,showBarValue:_propTypes.default.bool,// 'bar', 'dist-bar' or 'column'
reduceXTicks:_propTypes.default.bool,// 'bar', 'dist-bar' or 'area'
showControls:_propTypes.default.bool,// 'line' only
showBrush:_propTypes.default.oneOf([!0,"yes",!1,"no","auto"]),onBrushEnd:_propTypes.default.func,// 'line-multi' or 'dual-line'
yAxis2Format:_propTypes.default.string,// 'line', 'time-pivot', 'dual-line' or 'line-multi'
lineInterpolation:_propTypes.default.string,// 'pie' only
isDonut:_propTypes.default.bool,isPieLabelOutside:_propTypes.default.bool,pieLabelType:_propTypes.default.oneOf(["key","value","percent","key_value","key_percent"]),showLabels:_propTypes.default.bool,// 'area' only
areaStackedStyle:_propTypes.default.string,// 'bubble' only
entity:_propTypes.default.string,maxBubbleSize:_propTypes.default.number,xField:_PropTypes.stringOrObjectWithLabelType,yField:_PropTypes.stringOrObjectWithLabelType,sizeField:_PropTypes.stringOrObjectWithLabelType,// time-pivot only
baseColor:_PropTypes.rgbObjectType},NOOP=function(){},formatter=(0,_numberFormat.getNumberFormatter)();// Limit on how large axes margins can grow as the chart window is resized
function nvd3Vis(a,b){function c(a){return 0<=a.indexOf(N)}var d=b.data,e=b.width,f=b.height,g=b.annotationData,h=b.annotationLayers,i=void 0===h?[]:h,j=b.areaStackedStyle,k=b.baseColor,l=b.bottomMargin,m=b.colorScheme,n=b.comparisonType,o=b.contribution,p=b.entity,q=b.isBarStacked,r=b.isDonut,s=b.isPieLabelOutside,t=b.leftMargin,u=b.lineInterpolation,v=void 0===u?"linear":u,w=b.maxBubbleSize,x=b.onBrushEnd,y=void 0===x?NOOP:x,z=b.onError,A=void 0===z?NOOP:z,B=b.orderBars,C=b.pieLabelType,D=b.reduceXTicks,E=void 0!==D&&D,F=b.showBarValue,G=b.showBrush,H=b.showControls,I=b.showLabels,J=b.showLegend,K=b.showMarkers,L=b.sizeField,M=b.useRichTooltip,N=b.vizType,O=b.xAxisFormat,P=b.numberFormat,Q=b.xAxisLabel,R=b.xAxisShowMinMax,S=void 0!==R&&R,T=b.xField,U=b.xIsLogScale,V=b.xTicksLayout,W=b.yAxisFormat,X=b.yAxis2Format,Y=b.yAxisBounds,Z=b.yAxisLabel,$=b.yAxisShowMinMax,_=void 0!==$&&$,aa=b.yField,ba=b.yIsLogScale,ca=null!==document.querySelector("#explorer-container"),da=a;da.innerHTML="";var ea,fa=i.filter(function(a){return a.show}),ga=da.parentElement&&""!==da.parentElement.id?da.parentElement.id:null,ha=e,ia="key";da.style.width=e+"px",da.style.height=f+"px";var ja=function(){var h=_d.default.select(a);h.classed("superset-legacy-chart-nvd3",!0),h.classed("superset-legacy-chart-nvd3-"+(0,_lodash.kebabCase)(N),!0);var u=h.select("svg");u.empty()&&(u=h.append("svg"));var z="bullet"===N?Math.min(f,50):f,D=c(TIMESERIES_VIZ_TYPES),R="staggered"===V,$="auto"===V&&c(["column","dist_bar"])||"45\xB0"===V?45:0;if(45===$&&(0,_isTruthy.default)(G))return A((0,_translation.t)("You cannot use 45\xB0 tick layout along with the time range filter")),null;var da=(0,_isTruthy.default)(G)||"auto"===G&&f>=MIN_HEIGHT_FOR_BRUSH&&"45\xB0"!==V,ja=(0,_numberFormat.getNumberFormatter)(P);switch(N){case"line":da?(ea=_nvd.default.models.lineWithFocusChart(),R&&(ea.focus.margin({bottom:40}),ea.focusHeight(80)),ea.focus.xScale(_d.default.time.scale.utc())):ea=_nvd.default.models.lineChart(),ea.xScale(_d.default.time.scale.utc()),ea.interpolate(v),ea.clipEdge(!1);break;case"time_pivot":ea=_nvd.default.models.lineChart(),ea.xScale(_d.default.time.scale.utc()),ea.interpolate(v);break;case"dual_line":case"line_multi":ea=_nvd.default.models.multiChart(),ea.interpolate(v);break;case"bar":ea=_nvd.default.models.multiBarChart().showControls(H).groupSpacing(.1),E||(ha=(0,_utils.computeBarChartWidth)(d,q,e)),ea.width(ha),ea.xAxis.showMaxMin(!1),ea.stacked(q);break;case"dist_bar":ea=_nvd.default.models.multiBarChart().showControls(H).reduceXTicks(E).groupSpacing(.1),ea.xAxis.showMaxMin(!1),ea.stacked(q),B&&d.forEach(function(a){a.values.sort(function(c,a){return(0,_utils.tryNumify)(c.x)<(0,_utils.tryNumify)(a.x)?-1:1})}),E||(ha=(0,_utils.computeBarChartWidth)(d,q,e)),ea.width(ha);break;case"pie":if(ea=_nvd.default.models.pieChart(),ia="x",ea.valueFormat(ja),r&&ea.donut(!0),ea.showLabels(I),ea.labelsOutside(s),ea.labelThreshold(.05),ea.cornerRadius(!0),0<=["key","value","percent"].indexOf(C))ea.labelType(C);else if("key_value"===C)ea.labelType(function(a){return a.data.x+": "+ja(a.data.y)});else if("key_percent"===C){var Ma=_d.default.sum(d,function(a){return a.y});ea.tooltip.valueFormatter(function(a){return(100*(a/Ma)).toFixed()+"%"}),ea.labelType(function(a){return a.data.x+": "+(100*(a.data.y/Ma)).toFixed()+"%"})}// Pie chart does not need top margin
ea.margin({top:0});break;case"column":ea=_nvd.default.models.multiBarChart().reduceXTicks(!1);break;case"compare":ea=_nvd.default.models.cumulativeLineChart(),ea.xScale(_d.default.time.scale.utc()),ea.useInteractiveGuideline(!0),ea.xAxis.showMaxMin(!1);break;case"bubble":ea=_nvd.default.models.scatterChart(),ea.showDistX(!1),ea.showDistY(!1),ea.tooltip.contentGenerator(function(a){return(0,_utils.generateBubbleTooltipContent)({point:a.point,entity:p,xField:T,yField:aa,sizeField:L,xFormatter:(0,_utils.getTimeOrNumberFormatter)(O),yFormatter:(0,_utils.getTimeOrNumberFormatter)(W),sizeFormatter:formatter})}),ea.pointRange([5,Math.pow(w,2)]),ea.pointDomain([0,_d.default.max(d,function(a){return _d.default.max(a.values,function(a){return a.size})})]);break;case"area":ea=_nvd.default.models.stackedAreaChart(),ea.showControls(H),ea.style(j),ea.xScale(_d.default.time.scale.utc());break;case"box_plot":ia="label",ea=_nvd.default.models.boxPlotChart(),ea.x(function(a){return a.label}),ea.maxBoxWidth(75);// prevent boxes from being incredibly wide
break;case"bullet":ea=_nvd.default.models.bulletChart();break;default:throw new Error("Unrecognized visualization for nvd3"+N);}// Assuming the container has padding already other than for top margin
ea.margin({left:0,right:0,bottom:0}),F&&((0,_utils.drawBarValues)(u,d,q,W),ea.dispatch.on("stateChange.drawBarValues",function(){(0,_utils.drawBarValues)(u,d,q,W)})),da&&y!==NOOP&&ea.focus&&ea.focus.dispatch.on("brush",function(a){var b=(0,_utils.stringifyTimeRange)(a.extent);b&&a.brush.on("brushend",function(){y(b)})}),ea.xAxis&&ea.xAxis.staggerLabels&&ea.xAxis.staggerLabels(R),ea.xAxis&&ea.xAxis.rotateLabels&&ea.xAxis.rotateLabels($),ea.x2Axis&&ea.x2Axis.staggerLabels&&ea.x2Axis.staggerLabels(R),ea.x2Axis&&ea.x2Axis.rotateLabels&&ea.x2Axis.rotateLabels($),"showLegend"in ea&&"undefined"!=typeof J&&(ha<BREAKPOINTS.small&&"pie"!==N?ea.showLegend(!1):ea.showLegend(J)),ba&&ea.yScale(_d.default.scale.log()),U&&ea.xScale(_d.default.scale.log());var ka;if(D?(ka=(0,_timeFormat.getTimeFormatter)(O),ea.interactiveLayer.tooltip.headerFormatter(_timeFormat.smartDateVerboseFormatter)):ka=(0,_utils.getTimeOrNumberFormatter)(O),ea.x2Axis&&ea.x2Axis.tickFormat&&ea.x2Axis.tickFormat(ka),ea.xAxis&&ea.xAxis.tickFormat){var Na=c(["dist_bar","box_plot"]);Na?ea.xAxis.tickFormat(function(a){return a.length>MAX_NO_CHARACTERS_IN_LABEL?a.substring(0,MAX_NO_CHARACTERS_IN_LABEL)+"\u2026":a}):ea.xAxis.tickFormat(ka)}var la=(0,_utils.getTimeOrNumberFormatter)(W);if(ea.yAxis&&ea.yAxis.tickFormat&&((o||"percentage"===n)&&(la=(0,_numberFormat.getNumberFormatter)(_numberFormat.NumberFormats.PERCENT_1_POINT)),ea.yAxis.tickFormat(la)),ea.y2Axis&&ea.y2Axis.tickFormat&&ea.y2Axis.tickFormat(la),ea.yAxis&&ea.yAxis.ticks(5),ea.y2Axis&&ea.y2Axis.ticks(5),(0,_utils.setAxisShowMaxMin)(ea.xAxis,S),(0,_utils.setAxisShowMaxMin)(ea.x2Axis,S),(0,_utils.setAxisShowMaxMin)(ea.yAxis,_),(0,_utils.setAxisShowMaxMin)(ea.y2Axis,_),"time_pivot"===N){if(k){var ma=k.r,na=k.g,oa=k.b;ea.color(function(a){var b=0<a.rank?.5*a.perc:1;return"rgba("+ma+", "+na+", "+oa+", "+b+")"})}ea.useInteractiveGuideline(!0),ea.interactiveLayer.tooltip.contentGenerator(function(a){return(0,_utils.generateTimePivotTooltip)(a,ka,la)})}else if("bullet"!==N){var Oa=getScale(m);ea.color(function(a){return a.color||Oa((0,_utils.cleanColorInput)(a[ia]))})}if(c(["line","area"])&&M&&(ea.useInteractiveGuideline(!0),"line"===N?ea.interactiveLayer.tooltip.contentGenerator(function(a){return(0,_utils.generateRichLineTooltipContent)(a,_timeFormat.smartDateVerboseFormatter,la)}):"expand"!==j&&ea.interactiveLayer.tooltip.contentGenerator(function(a){return(0,_utils.generateAreaChartTooltipContent)(a,_timeFormat.smartDateVerboseFormatter,la)})),c(["dual_line","line_multi"])){var b=(0,_numberFormat.getNumberFormatter)(W),pa=(0,_numberFormat.getNumberFormatter)(X);ea.yAxis1.tickFormat(b),ea.yAxis2.tickFormat(pa);var Pa=d.map(function(a){return 1===a.yAxis?b:pa});ea.useInteractiveGuideline(!0),ea.interactiveLayer.tooltip.contentGenerator(function(a){return(0,_utils.generateMultiLineTooltipContent)(a,ka,Pa)}),"dual_line"===N?ea.showLegend(ha>BREAKPOINTS.small):ea.showLegend(J)}// This is needed for correct chart dimensions if a chart is rendered in a hidden container
if(ea.width(ha),ea.height(z),u.datum(d).transition().duration(500).attr("height",z).attr("width",ha).call(ea),ba&&ea.yAxis.tickFormat(function(a){return 0!==a&&0==Math.log10(a)%1?la(a):""}),0<$){// shift labels to the left so they look better
var Qa=u.select(".nv-x.nv-axis > g").selectAll("g");Qa.selectAll("text").attr("dx",-6.5)}var qa=function(){if(ea.yDomain&&Array.isArray(Y)&&2===Y.length){var a=Y[0],b=Y[1],e=(0,_core.isDefined)(a)&&!Number.isNaN(a),f=(0,_core.isDefined)(b)&&!Number.isNaN(b);if((e||f)&&"area"===N&&"expand"===ea.style())ea.yDomain([0,1]);else if((e||f)&&"area"===N&&"stream"===ea.style())ea.yDomain((0,_utils.computeStackedYDomain)(d));else if(e&&f)ea.yDomain([a,b]),ea.clipEdge(!0);else if(e||f){// Only one of the bounds has been set, so we need to manually calculate the other one
var g=0,h=1;// These viz types can be stacked
// They correspond to the nvd3 stackedAreaChart and multiBarChart
if("area"===N||c(["bar","dist_bar"])&&ea.stacked()){// This is a stacked area chart or a stacked bar chart
var i=(0,_utils.computeStackedYDomain)(d);g=i[0],h=i[1]}else{var j=(0,_utils.computeYDomain)(d);g=j[0],h=j[1]}var k=e?a:g,l=f?b:h;ea.yDomain([k,l]),ea.clipEdge(!0)}}};// align yAxis1 and yAxis2 ticks
if(qa(),ea.dispatch&&ea.dispatch.stateChange&&ea.dispatch.on("stateChange.applyYAxisBounds",qa),c(["dual_line","line_multi"])){var ra=ea.yAxis1.ticks(),sa=ea.yAxis1.scale().domain(ea.yAxis1.domain()).nice(ra).ticks(ra),ta=ea.yAxis2.scale().domain(ea.yAxis2.domain()).nice(ra).ticks(ra),ua=sa.length-ta.length;if(sa.length&&ta.length&&0!==ua){for(var va=0>ua?sa:ta,wa=va[1]-va[0],xa=0;xa<Math.abs(ua);xa++)0==xa%2?va.unshift(va[0]-wa):va.push(va[va.length-1]+wa);ea.yDomain1([sa[0],sa[sa.length-1]]),ea.yDomain2([ta[0],ta[ta.length-1]]),ea.yAxis1.tickValues(sa),ea.yAxis2.tickValues(ta)}}if(K&&(u.selectAll(".nv-point").style("stroke-opacity",1).style("fill-opacity",1),ea.dispatch.on("stateChange.showMarkers",function(){setTimeout(function(){u.selectAll(".nv-point").style("stroke-opacity",1).style("fill-opacity",1)},10)})),void 0!==ea.yAxis||void 0!==ea.yAxis2){// Hack to adjust y axis left margin to accommodate long numbers
var ya=Math.ceil(Math.min(e*(ca?.01:.03),MAX_MARGIN_PAD)),za=ea.margin();// Hack to adjust margins to accommodate long axis tick labels.
// - has to be done only after the chart has been rendered once
// - measure the width or height of the labels
// ---- (x axis labels are rotated 45 degrees so we use height),
// - adjust margins based on these measures and render again
ea.xAxis&&(za.bottom=28);var Aa=(0,_utils.getMaxLabelSize)(u,ea.yAxis2?"nv-y1":"nv-y"),Ba=(0,_utils.getMaxLabelSize)(u,"nv-x");if(za.left=Aa+ya,Z&&""!==Z&&(za.left+=25),F&&(za.top+=24),S&&(za.right=Math.max(20,Ba/2)+ya),45===$?(za.bottom=Ba*Math.sin(Math.PI*$/180)+ya+30,za.right=Ba*Math.cos(Math.PI*$/180)+ya):R&&(za.bottom=40),c(["dual_line","line_multi"])){var Ra=(0,_utils.getMaxLabelSize)(u,"nv-y2");za.right=Ra+ya}if(l&&"auto"!==l&&(za.bottom=parseInt(l,10)),t&&"auto"!==t&&(za.left=t),Q&&""!==Q&&ea.xAxis){za.bottom+=25;var Sa=0;za.bottom&&!Number.isNaN(za.bottom)&&(Sa=za.bottom-45),ea.xAxis.axisLabel(Q).axisLabelDistance(Sa)}if(Z&&""!==Z&&ea.yAxis){var Ta=0;za.left&&!Number.isNaN(za.left)&&(Ta=za.left-70),ea.yAxis.axisLabel(Z).axisLabelDistance(Ta)}if(D&&g&&0<fa.length){// Time series annotations add additional data
var Ua=fa.filter(function(a){return a.annotationType===_AnnotationTypes.default.TIME_SERIES}).reduce(function(b,c){return b.concat((g[c.name]||[]).map(function(a){if(!a)return{};var b=Array.isArray(a.key)?c.name+", "+a.key.join(", "):c.name+", "+a.key;return _extends({},a,{key:b,color:c.color,strokeWidth:c.width,classed:c.opacity+" "+c.style+" nv-timeseries-annotation-layer showMarkers"+c.showMarkers+" hideLine"+c.hideLine})}))},[]);d.push.apply(d,Ua)}// Uniquely identify tooltips based on chartId so this chart instance only
// controls its own tooltips
// The below code should be run AFTER rendering because chart is updated in call()
if(ga&&(ea&&ea.interactiveLayer&&ea.interactiveLayer.tooltip&&ea.interactiveLayer.tooltip.classes([(0,_utils.generateTooltipClassName)(ga)]),ea&&ea.tooltip&&ea.tooltip.classes([(0,_utils.generateTooltipClassName)(ga)])),ea.margin(za),u.datum(d).transition().duration(500).attr("width",ha).attr("height",z).call(ea),window.addEventListener("scroll",(0,_lodash.throttle)(function(){return(0,_utils.hideTooltips)(!1)},250)),D&&0<fa.length){// Formula annotations
var Ca,Da,Ea,Fa=fa.filter(function(b){return b.annotationType===_AnnotationTypes.default.FORMULA}).map(function(b){return _extends({},b,{formula:_mathjs.default.parse(b.value)})});if("bar"===N?(Da=_d.default.min(d[0].values,function(a){return a.x}),Ca=_d.default.max(d[0].values,function(a){return a.x}),Ea=_d.default.scale.quantile().domain([Da,Ca]).range(ea.xAxis.range())):(Da=ea.xAxis.scale().domain()[0].valueOf(),Ca=ea.xAxis.scale().domain()[1].valueOf(),Ea=ea.xScale?ea.xScale():ea.xAxis.scale?ea.xAxis.scale():_d.default.scale.linear()),Ea&&Ea.clamp&&Ea.clamp(!0),0<Fa.length){var Va=[];if("bar"===N){// For bar-charts we want one data point evaluated for every
// data point that will be displayed.
var Wa=d.reduce(function(a,b){return b.values.forEach(function(b){return a.add(b.x)}),a},new Set);Va.push.apply(Va,Wa.values()),Va.sort()}else{// For every other time visualization it should be ok, to have a
// data points in even intervals.
var Ga=Math.min.apply(Math,d.map(function(a){return Math.min.apply(Math,a.values.slice(1).map(function(b,c){return b.x-a.values[c].x}))})),Ha=(Ca-Da)/(Ga||1);Ga=100>Ha?(Ca-Da)/100:Ga,Ga=500<Ha?(Ca-Da)/500:Ga,Va.push(Da);for(var Xa=Da;Xa<Ca;Xa+=Ga)Va.push(Xa);Va.push(Ca)}var x=Fa.map(function(a){return{key:a.name,values:Va.map(function(b){return{y:a.formula.eval({x:b}),x:b}}),color:a.color,strokeWidth:a.width,classed:a.opacity+" "+a.style}});d.push.apply(d,x)}var Ia=ea.xAxis1?ea.xAxis1:ea.xAxis,Ja=ea.yAxis1?ea.yAxis1:ea.yAxis,Ka=Ia.scale().range()[1],La=Ja.scale().range()[0];g&&(fa.filter(function(a){return a.annotationType===_AnnotationTypes.default.EVENT&&g&&g[a.name]}).forEach(function(b,c){var f=(0,_AnnotationTypes.applyNativeColumns)(b),d=_d.default.select(a).select(".nv-wrap").append("g").attr("class","nv-event-annotation-layer-"+c),e=f.color||getColor((0,_utils.cleanColorInput)(f.name),m),h=(0,_utils.tipFactory)(f),i=(g[f.name].records||[]).map(function(a){var b,c=new Date(_moment.default.utc(a[f.timeColumn]));return _extends({},a,(b={},b[f.timeColumn]=c,b))}).filter(function(a){return!Number.isNaN(a[f.timeColumn].getMilliseconds())});// Add event annotation layer
i.length&&d.selectAll("line").data(i).enter().append("line").attr({x1:function x1(a){return Ea(new Date(a[f.timeColumn]))},y1:0,x2:function x2(a){return Ea(new Date(a[f.timeColumn]))},y2:La}).attr("class",f.opacity+" "+f.style).style("stroke",e).style("stroke-width",f.width).on("mouseover",h.show).on("mouseout",h.hide).call(h),ea.focus&&ea.focus.dispatch.on("onBrush.event-annotation",function(){d.selectAll("line").data(i).attr({x1:function x1(a){return Ea(new Date(a[f.timeColumn]))},y1:0,x2:function x2(a){return Ea(new Date(a[f.timeColumn]))},y2:La,opacity:function opacity(a){var b=Ea(new Date(a[f.timeColumn]));return 0<b&&b<Ka?1:0}})})}),fa.filter(function(a){return a.annotationType===_AnnotationTypes.default.INTERVAL&&g&&g[a.name]}).forEach(function(b,c){var f=(0,_AnnotationTypes.applyNativeColumns)(b),d=_d.default.select(a).select(".nv-wrap").append("g").attr("class","nv-interval-annotation-layer-"+c),e=f.color||getColor((0,_utils.cleanColorInput)(f.name),m),h=(0,_utils.tipFactory)(f),i=(g[f.name].records||[]).map(function(a){var b,c=new Date(_moment.default.utc(a[f.timeColumn])),d=new Date(_moment.default.utc(a[f.intervalEndColumn]));return _extends({},a,(b={},b[f.timeColumn]=c,b[f.intervalEndColumn]=d,b))}).filter(function(a){return!Number.isNaN(a[f.timeColumn].getMilliseconds())&&!Number.isNaN(a[f.intervalEndColumn].getMilliseconds())});// Add interval annotation layer
i.length&&d.selectAll("rect").data(i).enter().append("rect").attr({x:function x(a){return Math.min(Ea(new Date(a[f.timeColumn])),Ea(new Date(a[f.intervalEndColumn])))},y:0,width:function(a){return Math.max(Math.abs(Ea(new Date(a[f.intervalEndColumn]))-Ea(new Date(a[f.timeColumn]))),1)},height:La}).attr("class",f.opacity+" "+f.style).style("stroke-width",f.width).style("stroke",e).style("fill",e).style("fill-opacity",.2).on("mouseover",h.show).on("mouseout",h.hide).call(h),ea.focus&&ea.focus.dispatch.on("onBrush.interval-annotation",function(){d.selectAll("rect").data(i).attr({x:function x(a){return Ea(new Date(a[f.timeColumn]))},width:function(a){var b=Ea(new Date(a[f.timeColumn])),c=Ea(new Date(a[f.intervalEndColumn]));return c-b}})})})),u.datum(d).attr("height",z).attr("width",ha).call(ea),ea.dispatch.on("renderEnd.timeseries-annotation",function(){_d.default.selectAll(".slice_container .nv-timeseries-annotation-layer.showMarkerstrue .nv-point").style("stroke-opacity",1).style("fill-opacity",1),_d.default.selectAll(".slice_container .nv-timeseries-annotation-layer.hideLinetrue").style("stroke-width",0)})}}return(0,_utils.wrapTooltip)(ea,e),ea};// Remove tooltips before rendering chart, if the chart is being re-rendered sometimes
// there are left over tooltips in the dom,
// this will clear them before rendering the chart again.
ga?(0,_utils.removeTooltip)(ga):(0,_utils.hideTooltips)(!0),_nvd.default.addGraph(ja)}nvd3Vis.displayName="NVD3",nvd3Vis.propTypes=propTypes;var _default=nvd3Vis;exports.default=_default;