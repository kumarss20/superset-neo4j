function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */ /* eslint-disable no-magic-numbers, complexity, sort-keys */ /* eslint-disable no-plusplus, react/forbid-prop-types */import{kebabCase,throttle}from"lodash";import d3 from"d3";import nv from"nvd3";import mathjs from"mathjs";import moment from"moment";import PropTypes from"prop-types";import{isDefined}from"@superset-ui/core";import{t}from"@superset-ui/translation";import{CategoricalColorNamespace}from"@superset-ui/color";import{getNumberFormatter,NumberFormats}from"@superset-ui/number-format";import{getTimeFormatter,smartDateVerboseFormatter}from"@superset-ui/time-format";import"nvd3/build/nv.d3.min.css";/* eslint-disable-next-line */import ANNOTATION_TYPES,{applyNativeColumns}from"./vendor/superset/AnnotationTypes";import isTruthy from"./utils/isTruthy";import{cleanColorInput,computeBarChartWidth,computeYDomain,computeStackedYDomain,drawBarValues,generateBubbleTooltipContent,generateMultiLineTooltipContent,generateRichLineTooltipContent,generateTimePivotTooltip,generateTooltipClassName,generateAreaChartTooltipContent,getMaxLabelSize,getTimeOrNumberFormatter,hideTooltips,tipFactory,tryNumify,removeTooltip,setAxisShowMaxMin,stringifyTimeRange,wrapTooltip}from"./utils";import{annotationLayerType,boxPlotValueType,bulletDataType,categoryAndValueXYType,rgbObjectType,numericXYType,numberOrAutoType,stringOrObjectWithLabelType}from"./PropTypes";import"./NVD3Vis.css";var getColor=CategoricalColorNamespace.getColor,getScale=CategoricalColorNamespace.getScale,MAX_MARGIN_PAD=30,MIN_HEIGHT_FOR_BRUSH=480,MAX_NO_CHARACTERS_IN_LABEL=40,BREAKPOINTS={small:340},TIMESERIES_VIZ_TYPES=["line","dual_line","line_multi","area","compare","bar","time_pivot"],propTypes={data:PropTypes.oneOfType([PropTypes.arrayOf(PropTypes.oneOfType([// pie
categoryAndValueXYType,// dist-bar
PropTypes.shape({key:PropTypes.string,values:PropTypes.arrayOf(categoryAndValueXYType)}),// area, line, compare, bar
PropTypes.shape({key:PropTypes.arrayOf(PropTypes.string),values:PropTypes.arrayOf(numericXYType)}),// dual-line
PropTypes.shape({classed:PropTypes.string,key:PropTypes.string,type:PropTypes.string,values:PropTypes.arrayOf(numericXYType),yAxis:PropTypes.number}),// box-plot
PropTypes.shape({label:PropTypes.string,values:PropTypes.arrayOf(boxPlotValueType)}),// bubble
PropTypes.shape({key:PropTypes.string,values:PropTypes.arrayOf(PropTypes.object)})])),// bullet
bulletDataType]),width:PropTypes.number,height:PropTypes.number,annotationData:PropTypes.object,annotationLayers:PropTypes.arrayOf(annotationLayerType),bottomMargin:numberOrAutoType,colorScheme:PropTypes.string,comparisonType:PropTypes.string,contribution:PropTypes.bool,leftMargin:numberOrAutoType,onError:PropTypes.func,showLegend:PropTypes.bool,showMarkers:PropTypes.bool,useRichTooltip:PropTypes.bool,vizType:PropTypes.oneOf(["area","bar","box_plot","bubble","bullet","compare","column","dist_bar","line","line_multi","time_pivot","pie","dual_line"]),xAxisFormat:PropTypes.string,numberFormat:PropTypes.string,xAxisLabel:PropTypes.string,xAxisShowMinMax:PropTypes.bool,xIsLogScale:PropTypes.bool,xTicksLayout:PropTypes.oneOf(["auto","staggered","45\xB0"]),yAxisFormat:PropTypes.string,yAxisBounds:PropTypes.arrayOf(PropTypes.number),yAxisLabel:PropTypes.string,yAxisShowMinMax:PropTypes.bool,yIsLogScale:PropTypes.bool,// 'dist-bar' only
orderBars:PropTypes.bool,// 'bar' or 'dist-bar'
isBarStacked:PropTypes.bool,showBarValue:PropTypes.bool,// 'bar', 'dist-bar' or 'column'
reduceXTicks:PropTypes.bool,// 'bar', 'dist-bar' or 'area'
showControls:PropTypes.bool,// 'line' only
showBrush:PropTypes.oneOf([!0,"yes",!1,"no","auto"]),onBrushEnd:PropTypes.func,// 'line-multi' or 'dual-line'
yAxis2Format:PropTypes.string,// 'line', 'time-pivot', 'dual-line' or 'line-multi'
lineInterpolation:PropTypes.string,// 'pie' only
isDonut:PropTypes.bool,isPieLabelOutside:PropTypes.bool,pieLabelType:PropTypes.oneOf(["key","value","percent","key_value","key_percent"]),showLabels:PropTypes.bool,// 'area' only
areaStackedStyle:PropTypes.string,// 'bubble' only
entity:PropTypes.string,maxBubbleSize:PropTypes.number,xField:stringOrObjectWithLabelType,yField:stringOrObjectWithLabelType,sizeField:stringOrObjectWithLabelType,// time-pivot only
baseColor:rgbObjectType},NOOP=function(){},formatter=getNumberFormatter();// Limit on how large axes margins can grow as the chart window is resized
function nvd3Vis(a,b){function c(a){return 0<=a.indexOf(O)}var d=b.data,e=b.width,f=b.height,g=b.annotationData,h=b.annotationLayers,i=void 0===h?[]:h,j=b.areaStackedStyle,k=b.baseColor,l=b.bottomMargin,m=b.colorScheme,n=b.comparisonType,o=b.contribution,p=b.entity,q=b.isBarStacked,r=b.isDonut,s=b.isPieLabelOutside,u=b.leftMargin,v=b.lineInterpolation,w=void 0===v?"linear":v,x=b.maxBubbleSize,y=b.onBrushEnd,z=void 0===y?NOOP:y,A=b.onError,B=void 0===A?NOOP:A,C=b.orderBars,D=b.pieLabelType,E=b.reduceXTicks,F=void 0!==E&&E,G=b.showBarValue,H=b.showBrush,I=b.showControls,J=b.showLabels,K=b.showLegend,L=b.showMarkers,M=b.sizeField,N=b.useRichTooltip,O=b.vizType,P=b.xAxisFormat,Q=b.numberFormat,R=b.xAxisLabel,S=b.xAxisShowMinMax,T=void 0!==S&&S,U=b.xField,V=b.xIsLogScale,W=b.xTicksLayout,X=b.yAxisFormat,Y=b.yAxis2Format,Z=b.yAxisBounds,$=b.yAxisLabel,_=b.yAxisShowMinMax,aa=void 0!==_&&_,ba=b.yField,ca=b.yIsLogScale,da=null!==document.querySelector("#explorer-container"),ea=a;ea.innerHTML="";var fa,ga=i.filter(function(a){return a.show}),ha=ea.parentElement&&""!==ea.parentElement.id?ea.parentElement.id:null,ia=e,ja="key";ea.style.width=e+"px",ea.style.height=f+"px";var ka=function(){var h=d3.select(a);h.classed("superset-legacy-chart-nvd3",!0),h.classed("superset-legacy-chart-nvd3-"+kebabCase(O),!0);var v=h.select("svg");v.empty()&&(v=h.append("svg"));var y="bullet"===O?Math.min(f,50):f,A=c(TIMESERIES_VIZ_TYPES),E="staggered"===W,S="auto"===W&&c(["column","dist_bar"])||"45\xB0"===W?45:0;if(45===S&&isTruthy(H))return B(t("You cannot use 45\xB0 tick layout along with the time range filter")),null;var _=isTruthy(H)||"auto"===H&&f>=MIN_HEIGHT_FOR_BRUSH&&"45\xB0"!==W,ea=getNumberFormatter(Q);switch(O){case"line":_?(fa=nv.models.lineWithFocusChart(),E&&(fa.focus.margin({bottom:40}),fa.focusHeight(80)),fa.focus.xScale(d3.time.scale.utc())):fa=nv.models.lineChart(),fa.xScale(d3.time.scale.utc()),fa.interpolate(w),fa.clipEdge(!1);break;case"time_pivot":fa=nv.models.lineChart(),fa.xScale(d3.time.scale.utc()),fa.interpolate(w);break;case"dual_line":case"line_multi":fa=nv.models.multiChart(),fa.interpolate(w);break;case"bar":fa=nv.models.multiBarChart().showControls(I).groupSpacing(.1),F||(ia=computeBarChartWidth(d,q,e)),fa.width(ia),fa.xAxis.showMaxMin(!1),fa.stacked(q);break;case"dist_bar":fa=nv.models.multiBarChart().showControls(I).reduceXTicks(F).groupSpacing(.1),fa.xAxis.showMaxMin(!1),fa.stacked(q),C&&d.forEach(function(a){a.values.sort(function(c,a){return tryNumify(c.x)<tryNumify(a.x)?-1:1})}),F||(ia=computeBarChartWidth(d,q,e)),fa.width(ia);break;case"pie":if(fa=nv.models.pieChart(),ja="x",fa.valueFormat(ea),r&&fa.donut(!0),fa.showLabels(J),fa.labelsOutside(s),fa.labelThreshold(.05),fa.cornerRadius(!0),0<=["key","value","percent"].indexOf(D))fa.labelType(D);else if("key_value"===D)fa.labelType(function(a){return a.data.x+": "+ea(a.data.y)});else if("key_percent"===D){var Ma=d3.sum(d,function(a){return a.y});fa.tooltip.valueFormatter(function(a){return(100*(a/Ma)).toFixed()+"%"}),fa.labelType(function(a){return a.data.x+": "+(100*(a.data.y/Ma)).toFixed()+"%"})}// Pie chart does not need top margin
fa.margin({top:0});break;case"column":fa=nv.models.multiBarChart().reduceXTicks(!1);break;case"compare":fa=nv.models.cumulativeLineChart(),fa.xScale(d3.time.scale.utc()),fa.useInteractiveGuideline(!0),fa.xAxis.showMaxMin(!1);break;case"bubble":fa=nv.models.scatterChart(),fa.showDistX(!1),fa.showDistY(!1),fa.tooltip.contentGenerator(function(a){return generateBubbleTooltipContent({point:a.point,entity:p,xField:U,yField:ba,sizeField:M,xFormatter:getTimeOrNumberFormatter(P),yFormatter:getTimeOrNumberFormatter(X),sizeFormatter:formatter})}),fa.pointRange([5,Math.pow(x,2)]),fa.pointDomain([0,d3.max(d,function(a){return d3.max(a.values,function(a){return a.size})})]);break;case"area":fa=nv.models.stackedAreaChart(),fa.showControls(I),fa.style(j),fa.xScale(d3.time.scale.utc());break;case"box_plot":ja="label",fa=nv.models.boxPlotChart(),fa.x(function(a){return a.label}),fa.maxBoxWidth(75);// prevent boxes from being incredibly wide
break;case"bullet":fa=nv.models.bulletChart();break;default:throw new Error("Unrecognized visualization for nvd3"+O);}// Assuming the container has padding already other than for top margin
fa.margin({left:0,right:0,bottom:0}),G&&(drawBarValues(v,d,q,X),fa.dispatch.on("stateChange.drawBarValues",function(){drawBarValues(v,d,q,X)})),_&&z!==NOOP&&fa.focus&&fa.focus.dispatch.on("brush",function(a){var b=stringifyTimeRange(a.extent);b&&a.brush.on("brushend",function(){z(b)})}),fa.xAxis&&fa.xAxis.staggerLabels&&fa.xAxis.staggerLabels(E),fa.xAxis&&fa.xAxis.rotateLabels&&fa.xAxis.rotateLabels(S),fa.x2Axis&&fa.x2Axis.staggerLabels&&fa.x2Axis.staggerLabels(E),fa.x2Axis&&fa.x2Axis.rotateLabels&&fa.x2Axis.rotateLabels(S),"showLegend"in fa&&"undefined"!=typeof K&&(ia<BREAKPOINTS.small&&"pie"!==O?fa.showLegend(!1):fa.showLegend(K)),ca&&fa.yScale(d3.scale.log()),V&&fa.xScale(d3.scale.log());var ka;if(A?(ka=getTimeFormatter(P),fa.interactiveLayer.tooltip.headerFormatter(smartDateVerboseFormatter)):ka=getTimeOrNumberFormatter(P),fa.x2Axis&&fa.x2Axis.tickFormat&&fa.x2Axis.tickFormat(ka),fa.xAxis&&fa.xAxis.tickFormat){var Na=c(["dist_bar","box_plot"]);Na?fa.xAxis.tickFormat(function(a){return a.length>MAX_NO_CHARACTERS_IN_LABEL?a.substring(0,MAX_NO_CHARACTERS_IN_LABEL)+"\u2026":a}):fa.xAxis.tickFormat(ka)}var la=getTimeOrNumberFormatter(X);if(fa.yAxis&&fa.yAxis.tickFormat&&((o||"percentage"===n)&&(la=getNumberFormatter(NumberFormats.PERCENT_1_POINT)),fa.yAxis.tickFormat(la)),fa.y2Axis&&fa.y2Axis.tickFormat&&fa.y2Axis.tickFormat(la),fa.yAxis&&fa.yAxis.ticks(5),fa.y2Axis&&fa.y2Axis.ticks(5),setAxisShowMaxMin(fa.xAxis,T),setAxisShowMaxMin(fa.x2Axis,T),setAxisShowMaxMin(fa.yAxis,aa),setAxisShowMaxMin(fa.y2Axis,aa),"time_pivot"===O){if(k){var ma=k.r,na=k.g,oa=k.b;fa.color(function(a){var b=0<a.rank?.5*a.perc:1;return"rgba("+ma+", "+na+", "+oa+", "+b+")"})}fa.useInteractiveGuideline(!0),fa.interactiveLayer.tooltip.contentGenerator(function(a){return generateTimePivotTooltip(a,ka,la)})}else if("bullet"!==O){var Oa=getScale(m);fa.color(function(a){return a.color||Oa(cleanColorInput(a[ja]))})}if(c(["line","area"])&&N&&(fa.useInteractiveGuideline(!0),"line"===O?fa.interactiveLayer.tooltip.contentGenerator(function(a){return generateRichLineTooltipContent(a,smartDateVerboseFormatter,la)}):"expand"!==j&&fa.interactiveLayer.tooltip.contentGenerator(function(a){return generateAreaChartTooltipContent(a,smartDateVerboseFormatter,la)})),c(["dual_line","line_multi"])){var b=getNumberFormatter(X),pa=getNumberFormatter(Y);fa.yAxis1.tickFormat(b),fa.yAxis2.tickFormat(pa);var Pa=d.map(function(a){return 1===a.yAxis?b:pa});fa.useInteractiveGuideline(!0),fa.interactiveLayer.tooltip.contentGenerator(function(a){return generateMultiLineTooltipContent(a,ka,Pa)}),"dual_line"===O?fa.showLegend(ia>BREAKPOINTS.small):fa.showLegend(K)}// This is needed for correct chart dimensions if a chart is rendered in a hidden container
if(fa.width(ia),fa.height(y),v.datum(d).transition().duration(500).attr("height",y).attr("width",ia).call(fa),ca&&fa.yAxis.tickFormat(function(a){return 0!==a&&0==Math.log10(a)%1?la(a):""}),0<S){// shift labels to the left so they look better
var Qa=v.select(".nv-x.nv-axis > g").selectAll("g");Qa.selectAll("text").attr("dx",-6.5)}var qa=function(){if(fa.yDomain&&Array.isArray(Z)&&2===Z.length){var a=Z[0],b=Z[1],e=isDefined(a)&&!Number.isNaN(a),f=isDefined(b)&&!Number.isNaN(b);if((e||f)&&"area"===O&&"expand"===fa.style())fa.yDomain([0,1]);else if((e||f)&&"area"===O&&"stream"===fa.style())fa.yDomain(computeStackedYDomain(d));else if(e&&f)fa.yDomain([a,b]),fa.clipEdge(!0);else if(e||f){// Only one of the bounds has been set, so we need to manually calculate the other one
var g=0,h=1;// These viz types can be stacked
// They correspond to the nvd3 stackedAreaChart and multiBarChart
if("area"===O||c(["bar","dist_bar"])&&fa.stacked()){// This is a stacked area chart or a stacked bar chart
var i=computeStackedYDomain(d);g=i[0],h=i[1]}else{var j=computeYDomain(d);g=j[0],h=j[1]}var k=e?a:g,l=f?b:h;fa.yDomain([k,l]),fa.clipEdge(!0)}}};// align yAxis1 and yAxis2 ticks
if(qa(),fa.dispatch&&fa.dispatch.stateChange&&fa.dispatch.on("stateChange.applyYAxisBounds",qa),c(["dual_line","line_multi"])){var ra=fa.yAxis1.ticks(),sa=fa.yAxis1.scale().domain(fa.yAxis1.domain()).nice(ra).ticks(ra),ta=fa.yAxis2.scale().domain(fa.yAxis2.domain()).nice(ra).ticks(ra),ua=sa.length-ta.length;if(sa.length&&ta.length&&0!==ua){for(var va=0>ua?sa:ta,wa=va[1]-va[0],xa=0;xa<Math.abs(ua);xa++)0==xa%2?va.unshift(va[0]-wa):va.push(va[va.length-1]+wa);fa.yDomain1([sa[0],sa[sa.length-1]]),fa.yDomain2([ta[0],ta[ta.length-1]]),fa.yAxis1.tickValues(sa),fa.yAxis2.tickValues(ta)}}if(L&&(v.selectAll(".nv-point").style("stroke-opacity",1).style("fill-opacity",1),fa.dispatch.on("stateChange.showMarkers",function(){setTimeout(function(){v.selectAll(".nv-point").style("stroke-opacity",1).style("fill-opacity",1)},10)})),void 0!==fa.yAxis||void 0!==fa.yAxis2){// Hack to adjust y axis left margin to accommodate long numbers
var ya=Math.ceil(Math.min(e*(da?.01:.03),MAX_MARGIN_PAD)),za=fa.margin();// Hack to adjust margins to accommodate long axis tick labels.
// - has to be done only after the chart has been rendered once
// - measure the width or height of the labels
// ---- (x axis labels are rotated 45 degrees so we use height),
// - adjust margins based on these measures and render again
fa.xAxis&&(za.bottom=28);var Aa=getMaxLabelSize(v,fa.yAxis2?"nv-y1":"nv-y"),Ba=getMaxLabelSize(v,"nv-x");if(za.left=Aa+ya,$&&""!==$&&(za.left+=25),G&&(za.top+=24),T&&(za.right=Math.max(20,Ba/2)+ya),45===S?(za.bottom=Ba*Math.sin(Math.PI*S/180)+ya+30,za.right=Ba*Math.cos(Math.PI*S/180)+ya):E&&(za.bottom=40),c(["dual_line","line_multi"])){var Ra=getMaxLabelSize(v,"nv-y2");za.right=Ra+ya}if(l&&"auto"!==l&&(za.bottom=parseInt(l,10)),u&&"auto"!==u&&(za.left=u),R&&""!==R&&fa.xAxis){za.bottom+=25;var Sa=0;za.bottom&&!Number.isNaN(za.bottom)&&(Sa=za.bottom-45),fa.xAxis.axisLabel(R).axisLabelDistance(Sa)}if($&&""!==$&&fa.yAxis){var Ta=0;za.left&&!Number.isNaN(za.left)&&(Ta=za.left-70),fa.yAxis.axisLabel($).axisLabelDistance(Ta)}if(A&&g&&0<ga.length){// Time series annotations add additional data
var Ua=ga.filter(function(a){return a.annotationType===ANNOTATION_TYPES.TIME_SERIES}).reduce(function(b,c){return b.concat((g[c.name]||[]).map(function(a){if(!a)return{};var b=Array.isArray(a.key)?c.name+", "+a.key.join(", "):c.name+", "+a.key;return _extends({},a,{key:b,color:c.color,strokeWidth:c.width,classed:c.opacity+" "+c.style+" nv-timeseries-annotation-layer showMarkers"+c.showMarkers+" hideLine"+c.hideLine})}))},[]);d.push.apply(d,Ua)}// Uniquely identify tooltips based on chartId so this chart instance only
// controls its own tooltips
// The below code should be run AFTER rendering because chart is updated in call()
if(ha&&(fa&&fa.interactiveLayer&&fa.interactiveLayer.tooltip&&fa.interactiveLayer.tooltip.classes([generateTooltipClassName(ha)]),fa&&fa.tooltip&&fa.tooltip.classes([generateTooltipClassName(ha)])),fa.margin(za),v.datum(d).transition().duration(500).attr("width",ia).attr("height",y).call(fa),window.addEventListener("scroll",throttle(function(){return hideTooltips(!1)},250)),A&&0<ga.length){// Formula annotations
var Ca,Da,Ea,Fa=ga.filter(function(b){return b.annotationType===ANNOTATION_TYPES.FORMULA}).map(function(b){return _extends({},b,{formula:mathjs.parse(b.value)})});if("bar"===O?(Da=d3.min(d[0].values,function(a){return a.x}),Ca=d3.max(d[0].values,function(a){return a.x}),Ea=d3.scale.quantile().domain([Da,Ca]).range(fa.xAxis.range())):(Da=fa.xAxis.scale().domain()[0].valueOf(),Ca=fa.xAxis.scale().domain()[1].valueOf(),Ea=fa.xScale?fa.xScale():fa.xAxis.scale?fa.xAxis.scale():d3.scale.linear()),Ea&&Ea.clamp&&Ea.clamp(!0),0<Fa.length){var Va=[];if("bar"===O){// For bar-charts we want one data point evaluated for every
// data point that will be displayed.
var Wa=d.reduce(function(a,b){return b.values.forEach(function(b){return a.add(b.x)}),a},new Set);Va.push.apply(Va,Wa.values()),Va.sort()}else{// For every other time visualization it should be ok, to have a
// data points in even intervals.
var Ga=Math.min.apply(Math,d.map(function(a){return Math.min.apply(Math,a.values.slice(1).map(function(b,c){return b.x-a.values[c].x}))})),Ha=(Ca-Da)/(Ga||1);Ga=100>Ha?(Ca-Da)/100:Ga,Ga=500<Ha?(Ca-Da)/500:Ga,Va.push(Da);for(var Xa=Da;Xa<Ca;Xa+=Ga)Va.push(Xa);Va.push(Ca)}var x=Fa.map(function(a){return{key:a.name,values:Va.map(function(b){return{y:a.formula.eval({x:b}),x:b}}),color:a.color,strokeWidth:a.width,classed:a.opacity+" "+a.style}});d.push.apply(d,x)}var Ia=fa.xAxis1?fa.xAxis1:fa.xAxis,Ja=fa.yAxis1?fa.yAxis1:fa.yAxis,Ka=Ia.scale().range()[1],La=Ja.scale().range()[0];g&&(ga.filter(function(a){return a.annotationType===ANNOTATION_TYPES.EVENT&&g&&g[a.name]}).forEach(function(b,c){var f=applyNativeColumns(b),d=d3.select(a).select(".nv-wrap").append("g").attr("class","nv-event-annotation-layer-"+c),e=f.color||getColor(cleanColorInput(f.name),m),h=tipFactory(f),i=(g[f.name].records||[]).map(function(a){var b,c=new Date(moment.utc(a[f.timeColumn]));return _extends({},a,(b={},b[f.timeColumn]=c,b))}).filter(function(a){return!Number.isNaN(a[f.timeColumn].getMilliseconds())});// Add event annotation layer
i.length&&d.selectAll("line").data(i).enter().append("line").attr({x1:function x1(a){return Ea(new Date(a[f.timeColumn]))},y1:0,x2:function x2(a){return Ea(new Date(a[f.timeColumn]))},y2:La}).attr("class",f.opacity+" "+f.style).style("stroke",e).style("stroke-width",f.width).on("mouseover",h.show).on("mouseout",h.hide).call(h),fa.focus&&fa.focus.dispatch.on("onBrush.event-annotation",function(){d.selectAll("line").data(i).attr({x1:function x1(a){return Ea(new Date(a[f.timeColumn]))},y1:0,x2:function x2(a){return Ea(new Date(a[f.timeColumn]))},y2:La,opacity:function opacity(a){var b=Ea(new Date(a[f.timeColumn]));return 0<b&&b<Ka?1:0}})})}),ga.filter(function(a){return a.annotationType===ANNOTATION_TYPES.INTERVAL&&g&&g[a.name]}).forEach(function(b,c){var f=applyNativeColumns(b),d=d3.select(a).select(".nv-wrap").append("g").attr("class","nv-interval-annotation-layer-"+c),e=f.color||getColor(cleanColorInput(f.name),m),h=tipFactory(f),i=(g[f.name].records||[]).map(function(a){var b,c=new Date(moment.utc(a[f.timeColumn])),d=new Date(moment.utc(a[f.intervalEndColumn]));return _extends({},a,(b={},b[f.timeColumn]=c,b[f.intervalEndColumn]=d,b))}).filter(function(a){return!Number.isNaN(a[f.timeColumn].getMilliseconds())&&!Number.isNaN(a[f.intervalEndColumn].getMilliseconds())});// Add interval annotation layer
i.length&&d.selectAll("rect").data(i).enter().append("rect").attr({x:function x(a){return Math.min(Ea(new Date(a[f.timeColumn])),Ea(new Date(a[f.intervalEndColumn])))},y:0,width:function(a){return Math.max(Math.abs(Ea(new Date(a[f.intervalEndColumn]))-Ea(new Date(a[f.timeColumn]))),1)},height:La}).attr("class",f.opacity+" "+f.style).style("stroke-width",f.width).style("stroke",e).style("fill",e).style("fill-opacity",.2).on("mouseover",h.show).on("mouseout",h.hide).call(h),fa.focus&&fa.focus.dispatch.on("onBrush.interval-annotation",function(){d.selectAll("rect").data(i).attr({x:function x(a){return Ea(new Date(a[f.timeColumn]))},width:function(a){var b=Ea(new Date(a[f.timeColumn])),c=Ea(new Date(a[f.intervalEndColumn]));return c-b}})})})),v.datum(d).attr("height",y).attr("width",ia).call(fa),fa.dispatch.on("renderEnd.timeseries-annotation",function(){d3.selectAll(".slice_container .nv-timeseries-annotation-layer.showMarkerstrue .nv-point").style("stroke-opacity",1).style("fill-opacity",1),d3.selectAll(".slice_container .nv-timeseries-annotation-layer.hideLinetrue").style("stroke-width",0)})}}return wrapTooltip(fa,e),fa};// Remove tooltips before rendering chart, if the chart is being re-rendered sometimes
// there are left over tooltips in the dom,
// this will clear them before rendering the chart again.
ha?removeTooltip(ha):hideTooltips(!0),nv.addGraph(ka)}nvd3Vis.displayName="NVD3",nvd3Vis.propTypes=propTypes;export default nvd3Vis;