"use strict";exports.__esModule=!0,exports.default=void 0;var _core=require("@superset-ui/core"),_connection=require("@superset-ui/connection"),_ChartBuildQueryRegistrySingleton=_interopRequireDefault(require("../registries/ChartBuildQueryRegistrySingleton")),_ChartMetadataRegistrySingleton=_interopRequireDefault(require("../registries/ChartMetadataRegistrySingleton"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var ChartClient=/*#__PURE__*/function(){function a(a){void 0===a&&(a={}),_defineProperty(this,"client",void 0);var b=a,c=b.client,d=void 0===c?_connection.SupersetClient:c;this.client=d}var b=a.prototype;return b.loadFormData=function loadFormData(a,b){/* If sliceId is provided, use it to fetch stored formData from API */if("sliceId"in a){var c=this.client.get(_extends({endpoint:"/api/v1/formData/?slice_id="+a.sliceId},b)).then(function(a){return a.json}).then(function(a){return a.form_data});/*
       * If formData is also specified, override API result
       * with user-specified formData
       */return c.then(function(b){return _extends({},b,{},a.formData)})}/* If sliceId is not provided, returned formData wrapped in a Promise */return a.formData?Promise.resolve(a.formData):Promise.reject(new Error("At least one of sliceId or formData must be specified"))},b.loadQueryData=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b,c){var d,e,f,g,h,i,j;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=b.viz_type,e=(0,_ChartMetadataRegistrySingleton.default)(),f=(0,_ChartBuildQueryRegistrySingleton.default)(),!e.has(d)){a.next=12;break}return h=e.get(d),i=h.useLegacyApi,a.next=7,f.get(d);case 7:if(a.t0=a.sent,a.t0){a.next=10;break}a.t0=function(){return b};case 10:return j=a.t0,a.abrupt("return",this.client.post(_extends({endpoint:i?"/superset/explore_json/":"/api/v1/query/",postPayload:(g={},g[i?"form_data":"query_context"]=j(b),g)},c)).then(function(a){return a.json}));case 12:return a.abrupt("return",Promise.reject(new Error("Unknown chart type: "+d)));case 13:case"end":return a.stop();}},a,this)}));return function loadQueryData(){return a.apply(this,arguments)}}(),b.loadDatasource=function loadDatasource(a,b){return this.client.get(_extends({endpoint:"/superset/fetch_datasource_metadata?datasourceKey="+a},b)).then(function(a){return a.json})},b.loadAnnotation=function loadAnnotation(a){/* When annotation does not require query */return(0,_core.isDefined)(a.sourceType)?Promise.reject(new Error("This feature is not implemented yet.")):Promise.resolve({});// TODO: Implement
},b.loadAnnotations=function loadAnnotations(a){var b=this;return Array.isArray(a)&&0<a.length?Promise.all(a.map(function(a){return b.loadAnnotation(a)})).then(function(b){return a.reduce(function(a,c,d){var e=a;return e[c.name]=b[d],e},{})}):Promise.resolve({})},b.loadChartData=function loadChartData(a){var b=this;return this.loadFormData(a).then(function(a){return Promise.all([b.loadAnnotations(a.annotation_layers),b.loadDatasource(a.datasource),b.loadQueryData(a)]).then(function(b){var c=b[0],d=b[1],e=b[2];return{annotationData:c,datasource:d,formData:a,queryData:e}})})},a}();exports.default=ChartClient;