/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */ /* eslint no-use-before-define: ["error", { "functions": false }] */ /* eslint-disable sort-keys, no-magic-numbers, no-restricted-syntax, no-plusplus, babel/no-invalid-this */import d3 from"d3";import PropTypes from"prop-types";import nv from"nvd3";import{CategoricalColorNamespace}from"@superset-ui/color";import{getNumberFormatter}from"@superset-ui/number-format";import{getTimeFormatter}from"@superset-ui/time-format";import"./Rose.css";var propTypes={// Data is an object hashed by numeric value, perhaps timestamp
data:PropTypes.objectOf(PropTypes.arrayOf(PropTypes.shape({key:PropTypes.arrayOf(PropTypes.string),name:PropTypes.arrayOf(PropTypes.string),time:PropTypes.number,value:PropTypes.number}))),width:PropTypes.number,height:PropTypes.number,dateTimeFormat:PropTypes.string,numberFormat:PropTypes.string,useRichTooltip:PropTypes.bool,useAreaProportions:PropTypes.bool};function copyArc(a){return{startAngle:a.startAngle,endAngle:a.endAngle,innerRadius:a.innerRadius,outerRadius:a.outerRadius}}function sortValues(c,a){return c.value===a.value?c.name>a.name?1:-1:a.value-c.value}function Rose(a,b){function c(a){return a[z[0]].map(function(a,b){return{disabled:I.disabled[b],key:a.name}})}function d(a,b,c){var d=Math.floor(a.arcId/B),e=v?c[z[d]].filter(function(a){return!I.disabled[a.id%B]}).map(function(b){return{key:b.name,value:b.value,color:E(b.name),highlight:b.id===a.arcId}}):[{key:a.name,value:a.val,color:E(a.name)}];return{key:"Date",value:a.time,series:e}}// Compute inner and outer angles for each data point
function e(a){// Find the max sum of values across all time
for(var b=0,c=0,d=[],e=z,f=Array.isArray(e),g=0,e=f?e:e[Symbol.iterator]();;){var h;if(f){if(g>=e.length)break;h=e[g++]}else{if(g=e.next(),g.done)break;h=g.value}var j=h,k=y[j].reduce(function(b,a,c){return b+(I.disabled[c]?0:a.value)},0);b=k>b?k:b,d[c]=k,c++}// Compute angle occupied by each time grain
for(var l=2*Math.PI/A,m=[],n=0;n<=A;n++)m.push(l*n-Math.PI/2);// Compute proportion
for(var o=N/b,p=function(a,b){return w?Math.sqrt(o*N*a+b*b):o*a+b},q={data:[],extend:{},push:{},pieStart:{},pie:{},pieOver:{},mini:{},labels:[],groupLabels:[]},r=0,s=0;s<A;s++){for(var u=z[s],t=m[s],x=m[s+1],C=2*Math.PI/d[s],D=0,E=void 0,F=0,G=void 0,H=a[u],J=Array.isArray(H),K=0,H=J?H:H[Symbol.iterator]();;){var L;if(J){if(K>=H.length)break;L=H[K++]}else{if(K=H.next(),K.done)break;L=K.value}var M=L,v=I.disabled[r%B]?0:M.value,O=M.name,R=M.time;M.id=r,E=p(v,D),q.data.push({startAngle:t,endAngle:x,innerRadius:D,outerRadius:E,name:O,arcId:r,val:v,time:R}),q.extend[r]={startAngle:t,endAngle:x,innerRadius:D,name:O,outerRadius:E+P},q.push[r]={startAngle:t,endAngle:x,innerRadius:D+P,outerRadius:E+P},q.pieStart[r]={startAngle:t,endAngle:x,innerRadius:Q*N,outerRadius:N},q.mini[r]={startAngle:t,endAngle:x,innerRadius:D*Q,outerRadius:E*Q},r++,D=E}var Y=Object.assign({},q.data[s*B]);Y.outerRadius=N+20,Y.innerRadius=N+15,q.labels.push(Y);for(var S=a[u].concat().sort(sortValues),T=Array.isArray(S),U=0,S=T?S:S[Symbol.iterator]();;){var V;if(T){if(U>=S.length)break;V=S[U++]}else{if(U=S.next(),U.done)break;V=U.value}var W=V,X=I.disabled[W.id%B]?0:W.value;G=C*X+F,q.pie[W.id]={startAngle:F,endAngle:G,innerRadius:N*Q,outerRadius:N,percent:W.value/d[s]},q.pieOver[W.id]={startAngle:F,endAngle:G,innerRadius:N*Q,outerRadius:N+P},F=G}}return q.groupLabels=q.data.slice(0,B),q}function f(a,b){return function(c){var d=d3.interpolate(copyArc(c),copyArc(a));return function(a){return b(Object.assign(c,d(a)))}}}function h(a){return f(a,function(a){return F(a)})}function i(a){return f(a,function(a){return"translate("+F.centroid(a)+")"})}// Grab the ID range of segments stand between
// this segment and the edge of the circle
function j(a){if(W[a])return W[a];var b=Math.floor(a/B);return W[a]=[a+1,B*(b+1)-1],W[a]}// Get the IDs of all segments in a timeIndex
function k(a){if(X[a])return X[a];var b=Math.floor(a/B);return X[a]=[b*B,(b+1)*B-1],X[a]}function l(a,b){H.data(d(a,b,y)).hidden(!1);var c=d3.select(this);if(c.classed("hover",!0),0>Y&&!Z){c.select("path").interrupt().transition().duration(180).attrTween("d",h(V.extend[b]));var e=j(b);ba.filter(function(a){return e[0]<=a.arcId&&a.arcId<=e[1]}).interrupt().transition().duration(180).attrTween("d",function(a){return h(V.push[a.arcId])(a)})}else if(!Z){var f=k(Y);f[0]<=a.arcId&&a.arcId<=f[1]&&c.select("path").interrupt().transition().duration(180).attrTween("d",h(V.pieOver[b]))}}function m(a,b){H.hidden(!0);var c=d3.select(this);if(c.classed("hover",!1),0>Y&&!Z){c.select("path").interrupt().transition().duration(180).attrTween("d",h(V.data[b]));var e=j(b);ba.filter(function(a){return e[0]<=a.arcId&&a.arcId<=e[1]}).interrupt().transition().duration(180).attrTween("d",function(a){return h(V.data[a.arcId])(a)})}else if(!Z){var f=k(Y);f[0]<=a.arcId&&a.arcId<=f[1]&&c.select("path").interrupt().transition().duration(180).attrTween("d",h(V.pie[b]))}}function n(a,b){if(!Z){var c=d3.event.altKey?3750:375,e=k(b);if(0>Y)Z=!0,Y=b,_.interrupt().transition().duration(c).attrTween("transform",function(a){return i({outerRadius:0,innerRadius:0,startAngle:a.startAngle,endAngle:a.endAngle})(a)}).style("opacity",0),aa.attr("transform","translate("+F.centroid({outerRadius:N+20,innerRadius:N+15,startAngle:V.data[b].startAngle,endAngle:V.data[b].endAngle})+")").interrupt().transition().delay(c).duration(c).attrTween("transform",function(a){return i({outerRadius:N+20,innerRadius:N+15,startAngle:V.pie[e[0]+a.arcId].startAngle,endAngle:V.pie[e[0]+a.arcId].endAngle})(a)}).style("opacity",function(a){return I.disabled[a.arcId]||V.pie[e[0]+a.arcId].percent<O?0:1}),$.classed("clickable",function(a){return e[0]>a.arcId||a.arcId>e[1]}),ba.filter(function(a){return e[0]<=a.arcId&&a.arcId<=e[1]}).interrupt().transition().duration(c).attrTween("d",function(a){return h(V.pieStart[a.arcId])(a)}).transition().duration(c).attrTween("d",function(a){return h(V.pie[a.arcId])(a)}).each("end",function(){Z=!1}),ba.filter(function(a){return e[0]>a.arcId||a.arcId>e[1]}).interrupt().transition().duration(c).attrTween("d",function(a){return h(V.mini[a.arcId])(a)});else if(Y<e[0]||e[1]<Y){Z=!0;var f=k(Y);_.interrupt().transition().delay(c).duration(c).attrTween("transform",function(a){return i(V.labels[a.arcId/B])(a)}).style("opacity",1),aa.interrupt().transition().duration(c).attrTween("transform",i({outerRadius:N+20,innerRadius:N+15,startAngle:V.data[Y].startAngle,endAngle:V.data[Y].endAngle})).style("opacity",0),$.classed("clickable",!0),ba.filter(function(a){return f[0]<=a.arcId&&a.arcId<=f[1]}).interrupt().transition().duration(c).attrTween("d",function(a){return h(V.pieStart[a.arcId])(a)}).transition().duration(c).attrTween("d",function(a){return h(V.data[a.arcId])(a)}).each("end",function(){Y=-1,Z=!1}),ba.filter(function(a){return f[0]>a.arcId||a.arcId>f[1]}).interrupt().transition().delay(c).duration(c).attrTween("d",function(a){return h(V.data[a.arcId])(a)})}}}function o(){var a=d3.event.altKey?3e3:300;g.datum(c(y)).call(G);var b=e(y);if(Z=!0,0>Y)ba.style("opacity",1).interrupt().transition().duration(a).attrTween("d",function(a){return h(b.data[a.arcId])(a)}).each("end",function(){Z=!1,V=b}).transition().duration(0).style("opacity",function(a){return I.disabled[a.arcId%B]?0:1});else{var f=k(Y);ba.style("opacity",1).interrupt().transition().duration(a).attrTween("d",function(a){return f[0]<=a.arcId&&a.arcId<=f[1]?h(b.pie[a.arcId])(a):h(b.mini[a.arcId])(a)}).each("end",function(){Z=!1,V=b}).transition().duration(0).style("opacity",function(a){return I.disabled[a.arcId%B]?0:1}),aa.interrupt().transition().duration(a).attrTween("transform",function(a){return i({outerRadius:N+20,innerRadius:N+15,startAngle:b.pie[f[0]+a.arcId].startAngle,endAngle:b.pie[f[0]+a.arcId].endAngle})(a)}).style("opacity",function(a){return I.disabled[a.arcId]||V.pie[f[0]+a.arcId].percent<O?0:1})}}var p=b.data,q=b.width,r=b.height,s=b.colorScheme,t=b.dateTimeFormat,u=b.numberFormat,v=b.useRichTooltip,w=b.useAreaProportions,x=d3.select(a);x.classed("superset-legacy-chart-rose",!0);var y=p,z=Object.keys(y).map(function(a){return parseInt(a,10)}).sort(function(c,a){return c-a}),A=z.length,B=y[z[0]].length,C=getNumberFormatter(u),D=getTimeFormatter(t),E=CategoricalColorNamespace.getScale(s);d3.select(".nvtooltip").remove(),x.selectAll("*").remove();var F=d3.svg.arc(),G=nv.models.legend(),H=nv.models.tooltip(),I={disabled:y[z[0]].map(function(){return!1})},J=x.append("svg").attr("width",q).attr("height",r),K=J.append("g").attr("class","rose").append("g"),g=K.append("g").attr("class","legendWrap");G.width(q).color(function(a){return E(a.key)}),g.datum(c(y)).call(G),H.headerFormatter(D).valueFormatter(C);// Compute max radius, which the largest value will occupy
var L=r-G.height(),M={top:G.height()},N=Math.min(q,L)/2-35,O=.05,P=8,Q=.075,R="translate("+q/2+","+(L/2+M.top)+")",S=K.append("g").attr("transform",R).attr("class","roseWrap"),T=K.append("g").attr("transform",R).attr("class","labelsWrap"),U=K.append("g").attr("transform",R).attr("class","groupLabelsWrap"),V=e(y),W={},X={},Y=-1,Z=!1,$=S.selectAll("g").data(JSON.parse(JSON.stringify(V.data)))// deep copy data state
.enter().append("g").attr("class","segment").classed("clickable",!0).on("mouseover",l).on("mouseout",m).on("mousemove",function(){H()}).on("click",n),_=T.selectAll("g").data(JSON.parse(JSON.stringify(V.labels))).enter().append("g").attr("class","roseLabel").attr("transform",function(a){return"translate("+F.centroid(a)+")"});_.append("text").style("text-anchor","middle").style("fill","#000").text(function(a){return D(a.time)});var aa=U.selectAll("g").data(JSON.parse(JSON.stringify(V.groupLabels))).enter().append("g");aa.style("opacity",0).attr("class","roseGroupLabels").append("text").style("text-anchor","middle").style("fill","#000").text(function(a){return a.name});var ba=$.append("path").attr("class","arc").attr("fill",function(a){return E(a.name)}).attr("d",F);G.dispatch.on("stateChange",function(a){I.disabled!==a.disabled&&(I.disabled=a.disabled,o())})}Rose.displayName="Rose",Rose.propTypes=propTypes;export default Rose;