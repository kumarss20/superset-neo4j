/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */ /* eslint-disable sort-keys, no-magic-numbers, complexity, func-names */ /* eslint-disable babel/no-invalid-this, babel/new-cap, no-negated-condition */ /* eslint-disable prefer-destructuring, react/forbid-prop-types */import d3 from"d3";import PropTypes from"prop-types";import dt from"datatables.net-bs/js/dataTables.bootstrap";import dompurify from"dompurify";import{getNumberFormatter,NumberFormats}from"@superset-ui/number-format";import{getTimeFormatter}from"@superset-ui/time-format";import fixTableHeight from"./utils/fixTableHeight";import"datatables.net-bs/css/dataTables.bootstrap.css";import"./Table.css";window.$&&dt(window,window.$);var $=window.$||dt.$,propTypes={// Each object is { field1: value1, field2: value2 }
data:PropTypes.arrayOf(PropTypes.object),height:PropTypes.number,alignPositiveNegative:PropTypes.bool,colorPositiveNegative:PropTypes.bool,columns:PropTypes.arrayOf(PropTypes.shape({key:PropTypes.string,label:PropTypes.string,format:PropTypes.string})),filters:PropTypes.object,includeSearch:PropTypes.bool,metrics:PropTypes.arrayOf(PropTypes.oneOfType([PropTypes.string,PropTypes.object])),onAddFilter:PropTypes.func,onRemoveFilter:PropTypes.func,orderDesc:PropTypes.bool,pageLength:PropTypes.oneOfType([PropTypes.number,PropTypes.string]),percentMetrics:PropTypes.arrayOf(PropTypes.oneOfType([PropTypes.string,PropTypes.object])),tableFilter:PropTypes.bool,tableTimestampFormat:PropTypes.string,timeseriesLimitMetric:PropTypes.oneOfType([PropTypes.string,PropTypes.object])},formatValue=getNumberFormatter(NumberFormats.INTEGER),formatPercent=getNumberFormatter(NumberFormats.PERCENT_3_POINT),NOOP=function(){};function TableVis(a,b){function c(a){for(var b=[],c=0;c<d.length;c+=1)b.push(d[c][a]);return b}var d=b.data,e=b.height,f=b.alignPositiveNegative,g=void 0!==f&&f,h=b.colorPositiveNegative,j=b.columns,k=b.filters,l=void 0===k?{}:k,m=b.includeSearch,n=b.metrics,o=b.onAddFilter,p=void 0===o?NOOP:o,q=b.onRemoveFilter,r=void 0===q?NOOP:q,s=b.orderDesc,t=b.pageLength,u=b.percentMetrics,v=b.tableFilter,w=b.tableTimestampFormat,x=b.timeseriesLimitMetric,y=$(a);y.addClass("superset-legacy-chart-table");for(var z=(n||[]).map(function(a){return a.label||a})// Add percent metrics
.concat((u||[]).map(function(a){return"%"+a}))// Removing metrics (aggregates) that are strings
.filter(function(a){return"number"==typeof d[0][a]}),A={},B={},C=0;C<z.length;C+=1)g?A[z[C]]=d3.max(c(z[C]).map(Math.abs)):(A[z[C]]=d3.max(c(z[C])),B[z[C]]=d3.min(c(z[C])));var D=getTimeFormatter(w),E=d3.select(a);E.html("");var F=E.append("table").classed("dataframe dataframe table table-striped "+"table-condensed table-hover dataTable no-footer",!0).attr("width","100%");F.append("thead").append("tr").selectAll("th").data(j.map(function(a){return a.label})).enter().append("th").text(function(a){return a}),F.append("tbody").selectAll("tr").data(d).enter().append("tr").selectAll("td").data(function(a){return j.map(function(b){var c,d=b.key,e=b.format,f=a[d],g=0<=z.indexOf(d);return"__timestamp"===d&&(c=D(f)),"string"==typeof f&&(c="<span class=\"like-pre\">"+dompurify.sanitize(f)+"</span>"),g&&(c=getNumberFormatter(e)(f)),"%"===d[0]&&(c=formatPercent(f)),{col:d,val:f,html:c,isMetric:g}})}).enter().append("td").style("background-image",function(a){if(a.isMetric){var i=void 0!==h&&h&&0>a.val?150:0;if(g){var j=Math.abs(Math.round(100*(a.val/A[a.col])));// The 0.01 to 0.001 is a workaround for what appears to be a
// CSS rendering bug on flat, transparent colors
return"linear-gradient(to right, rgba("+i+",0,0,0.2), rgba("+i+",0,0,0.2) "+j+"%, "+("rgba(0,0,0,0.01) "+j+"%, rgba(0,0,0,0.001) 100%)")}var b=Math.abs(Math.max(A[a.col],0)),c=Math.abs(Math.min(B[a.col],0)),d=b+c,e=Math.round(100*(Math.min(c+a.val,c)/d)),f=Math.round(100*(Math.abs(a.val)/d));// The 0.01 to 0.001 is a workaround for what appears to be a
// CSS rendering bug on flat, transparent colors
return"linear-gradient(to right, rgba(0,0,0,0.01), rgba(0,0,0,0.001) "+e+"%, "+("rgba("+i+",0,0,0.2) "+e+"%, rgba("+i+",0,0,0.2) "+(e+f)+"%, ")+("rgba(0,0,0,0.01) "+(e+f)+"%, rgba(0,0,0,0.001) 100%)")}return null}).classed("text-right",function(a){return a.isMetric}).attr("title",function(a){return"string"==typeof a.val?a.val:Number.isNaN(a.val)?null:formatValue(a.val)}).attr("data-sort",function(a){return a.isMetric?a.val:null})// Check if the dashboard currently has a filter for each row
.classed("filtered",function(a){return l&&l[a.col]&&0<=l[a.col].indexOf(a.val)}).on("click",function(a){if(!a.isMetric&&v){var b=d3.select(this);b.classed("filtered")?(r(a.col,[a.val]),d3.select(this).classed("filtered",!1)):(d3.select(this).classed("filtered",!0),p(a.col,[a.val]))}}).style("cursor",function(a){return a.isMetric?"":"pointer"}).html(function(a){return a.html?a.html:a.val});var G=y.find(".dataTable").DataTable({paging:t&&0<t,pageLength:t,aaSorting:[],searching:void 0!==m&&m,bInfo:!1,scrollY:e+"px",scrollCollapse:!0,scrollX:!0});fixTableHeight(y.find(".dataTables_wrapper"),e);// Sorting table by main column
var H,I=Array.isArray(x)?x[0]:x;if(I?H=I.label||I:0<z.length&&(H=z[0]),H){var J=j.map(function(a){return a.key}),K=J.indexOf(H);G.column(K).order(s?"desc":"asc"),0>z.indexOf(H)&&G.column(K).visible(!1)}G.draw()}TableVis.displayName="TableVis",TableVis.propTypes=propTypes;export default TableVis;