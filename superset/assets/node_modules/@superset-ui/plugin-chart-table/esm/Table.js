import _pt from"prop-types";function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _inheritsLoose(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.__proto__=b}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}import React from"react";import DataTable from"@airbnb/lunar/lib/components/DataTable";import Text from"@airbnb/lunar/lib/components/Text";import Input from"@airbnb/lunar/lib/components/Input";import withStyles from"@airbnb/lunar/lib/composers/withStyles";import{createSelector}from"reselect";import getRenderer from"./getRenderer";var NOOP=function(){},defaultProps={alignPositiveNegative:!1,colorPositiveNegative:!1,filters:{},includeSearch:!1,onAddFilter:NOOP,onRemoveFilter:NOOP},SEARCH_BAR_HEIGHT=40,CHAR_WIDTH=10,CELL_PADDING=32,MAX_COLUMN_WIDTH=300,htmlTagRegex=/(<([^>]+)>)/gi;function getCellHash(a){return a.key+"#"+a.value}function getText(a,b){return b?b.format(a):"string"==typeof a?a.replace(htmlTagRegex,""):a+""}var TableVis=/*#__PURE__*/function(a){function b(b){var c;return c=a.call(this,b)||this,_defineProperty(_assertThisInitialized(c),"columnWidthSelector",createSelector(function(a){return a},function(a){var b=a.rows,c=a.columns,d=b&&0<b.length?Object.keys(b[0].data):[],e=0,f={},g={};return c.forEach(function(a){g[a.key]=a}),d.forEach(function(a){var c=g[a],h=c&&c.format,i=Math.max.apply(Math,b.map(function(b){return getText(b.data[a],h).length}).concat([a.length])),j=i*CHAR_WIDTH+CELL_PADDING;f[a]={maxWidth:MAX_COLUMN_WIDTH,width:j},e+=Math.min(j,MAX_COLUMN_WIDTH)}),{columnWidthMetaData:f,totalWidth:e}})),_defineProperty(_assertThisInitialized(c),"handleCellSelected",function(a){return function(){var b=c.state.selectedCells,d=c.props,e=d.tableFilter,f=d.onRemoveFilter,g=d.onAddFilter;if(e){var h=new Set(Array.from(b)),i=getCellHash(a);h.has(i)?(h.delete(i),f(a.key,[a.value])):(h.add(i),g(a.key,[a.value])),c.setState({selectedCells:h})}}}),_defineProperty(_assertThisInitialized(c),"isSelected",function(a){var b=c.state.selectedCells;return b.has(getCellHash(a))}),_defineProperty(_assertThisInitialized(c),"handleSearch",function(a){var b=c.state.searchKeyword,d=c.props.data;if(b!==a){var e=d.filter(function(b){var c=Object.keys(b.data).map(function(a){return b.data[a]}).join("|").toLowerCase();return 0<=c.indexOf(a.toLowerCase())});c.setState({filteredRows:e,searchKeyword:a})}}),c.state={filteredRows:[],// eslint-disable-next-line react/no-unused-state
filters:b.filters,searchKeyword:"",selectedCells:new Set},c}_inheritsLoose(b,a);var c=b.prototype;return c.render=function render(){var a=this,b=this.props,c=b.cx,d=b.data,e=b.columns,f=b.alignPositiveNegative,g=b.colorPositiveNegative,h=b.height,i=b.width,j=b.tableFilter,k=b.styles,l=b.includeSearch,m=this.state,n=m.filteredRows,o=m.searchKeyword,p=""===o?d:n,q={},r={};e.forEach(function(b){q[b.key]=getRenderer({alignPositiveNegative:f,colorPositiveNegative:g,column:b,enableFilter:j,handleCellSelected:a.handleCellSelected,isSelected:a.isSelected}),"metric"===b.type&&(r[b.key]={rightAlign:1})});var s=p&&0<p.length?Object.keys(p[0].data):[],t=this.columnWidthSelector({columns:e,rows:d});s.forEach(function(b){r[b]=_extends({},t.columnWidthMetaData[b],{},r[b]),q[b]||(q[b]=getRenderer({alignPositiveNegative:f,colorPositiveNegative:g,column:{key:b,label:b,type:"string"},enableFilter:j,handleCellSelected:a.handleCellSelected,isSelected:a.isSelected}))});var u=l?h-SEARCH_BAR_HEIGHT:h;return React.createElement(React.Fragment,null,l&&React.createElement("div",{className:c(k.searchBar)},React.createElement("div",{className:c(k.searchBox)},React.createElement(Input,{name:"search",label:"",placeholder:"Search",onChange:this.handleSearch,compact:!0,value:o})),React.createElement(Text,{small:!0},"Showing ",p.length,"/",d.length," rows")),React.createElement("div",{className:c(k.container)},React.createElement(DataTable,{data:p,keys:s,columnMetadata:r,zebra:!0,dynamicRowHeight:!0,rowHeight:"micro",renderers:q,height:u,width:Math.max(t.totalWidth,i),sortByValue:function convertToLowerCase(a,b){var c=a.data;return"string"==typeof c[b]?c[b].toLowerCase():c[b]}})))},b}(React.PureComponent);_defineProperty(TableVis,"propTypes",{data:_pt.arrayOf(_pt.any).isRequired,height:_pt.number.isRequired,width:_pt.number.isRequired,alignPositiveNegative:_pt.bool,colorPositiveNegative:_pt.bool,columns:_pt.arrayOf(_pt.any).isRequired,filters:_pt.objectOf(_pt.arrayOf(_pt.any)),includeSearch:_pt.bool,onAddFilter:_pt.func,onRemoveFilter:_pt.func,tableFilter:_pt.bool.isRequired}),_defineProperty(TableVis,"defaultProps",defaultProps),_defineProperty(TableVis,"getDerivedStateFromProps",function(a,b){var c=a.filters,d=b.selectedCells,e=b.filters;if(e!==c){var f=new Set(Array.from(d));return Object.keys(c).forEach(function(a){c[a].forEach(function(b){f.add(getCellHash({key:a,value:b}))})}),_extends({},b,{filters:c,selectedCells:f})}return b});export default withStyles(function(a){var b=a.unit;return{container:{display:"grid",overflowX:"scroll"},searchBar:{alignItems:"baseline",display:"flex",flexDirection:"row-reverse",flexGrow:0,marginBottom:b},searchBox:{marginLeft:b,// eslint-disable-next-line no-magic-numbers
width:25*b}}})(TableVis);