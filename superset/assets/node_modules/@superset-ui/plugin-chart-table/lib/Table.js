"use strict";exports.__esModule=!0,exports.default=void 0;var _propTypes=_interopRequireDefault(require("prop-types")),_react=_interopRequireDefault(require("react")),_DataTable=_interopRequireDefault(require("@airbnb/lunar/lib/components/DataTable")),_Text=_interopRequireDefault(require("@airbnb/lunar/lib/components/Text")),_Input=_interopRequireDefault(require("@airbnb/lunar/lib/components/Input")),_withStyles=_interopRequireDefault(require("@airbnb/lunar/lib/composers/withStyles")),_reselect=require("reselect"),_getRenderer=_interopRequireDefault(require("./getRenderer"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _inheritsLoose(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.__proto__=b}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var NOOP=function(){},defaultProps={alignPositiveNegative:!1,colorPositiveNegative:!1,filters:{},includeSearch:!1,onAddFilter:NOOP,onRemoveFilter:NOOP},SEARCH_BAR_HEIGHT=40,CHAR_WIDTH=10,CELL_PADDING=32,MAX_COLUMN_WIDTH=300,htmlTagRegex=/(<([^>]+)>)/gi;function getCellHash(a){return a.key+"#"+a.value}function getText(a,b){return b?b.format(a):"string"==typeof a?a.replace(htmlTagRegex,""):a+""}var TableVis=/*#__PURE__*/function(a){function b(b){var c;return c=a.call(this,b)||this,_defineProperty(_assertThisInitialized(c),"columnWidthSelector",(0,_reselect.createSelector)(function(a){return a},function(a){var b=a.rows,c=a.columns,d=b&&0<b.length?Object.keys(b[0].data):[],e=0,f={},g={};return c.forEach(function(a){g[a.key]=a}),d.forEach(function(a){var c=g[a],h=c&&c.format,i=Math.max.apply(Math,b.map(function(b){return getText(b.data[a],h).length}).concat([a.length])),j=i*CHAR_WIDTH+CELL_PADDING;f[a]={maxWidth:MAX_COLUMN_WIDTH,width:j},e+=Math.min(j,MAX_COLUMN_WIDTH)}),{columnWidthMetaData:f,totalWidth:e}})),_defineProperty(_assertThisInitialized(c),"handleCellSelected",function(a){return function(){var b=c.state.selectedCells,d=c.props,e=d.tableFilter,f=d.onRemoveFilter,g=d.onAddFilter;if(e){var h=new Set(Array.from(b)),i=getCellHash(a);h.has(i)?(h.delete(i),f(a.key,[a.value])):(h.add(i),g(a.key,[a.value])),c.setState({selectedCells:h})}}}),_defineProperty(_assertThisInitialized(c),"isSelected",function(a){var b=c.state.selectedCells;return b.has(getCellHash(a))}),_defineProperty(_assertThisInitialized(c),"handleSearch",function(a){var b=c.state.searchKeyword,d=c.props.data;if(b!==a){var e=d.filter(function(b){var c=Object.keys(b.data).map(function(a){return b.data[a]}).join("|").toLowerCase();return 0<=c.indexOf(a.toLowerCase())});c.setState({filteredRows:e,searchKeyword:a})}}),c.state={filteredRows:[],// eslint-disable-next-line react/no-unused-state
filters:b.filters,searchKeyword:"",selectedCells:new Set},c}_inheritsLoose(b,a);var c=b.prototype;return c.render=function render(){var a=this,b=this.props,c=b.cx,d=b.data,e=b.columns,f=b.alignPositiveNegative,g=b.colorPositiveNegative,h=b.height,i=b.width,j=b.tableFilter,k=b.styles,l=b.includeSearch,m=this.state,n=m.filteredRows,o=m.searchKeyword,p=""===o?d:n,q={},r={};e.forEach(function(b){q[b.key]=(0,_getRenderer.default)({alignPositiveNegative:f,colorPositiveNegative:g,column:b,enableFilter:j,handleCellSelected:a.handleCellSelected,isSelected:a.isSelected}),"metric"===b.type&&(r[b.key]={rightAlign:1})});var s=p&&0<p.length?Object.keys(p[0].data):[],t=this.columnWidthSelector({columns:e,rows:d});s.forEach(function(b){r[b]=_extends({},t.columnWidthMetaData[b],{},r[b]),q[b]||(q[b]=(0,_getRenderer.default)({alignPositiveNegative:f,colorPositiveNegative:g,column:{key:b,label:b,type:"string"},enableFilter:j,handleCellSelected:a.handleCellSelected,isSelected:a.isSelected}))});var u=l?h-SEARCH_BAR_HEIGHT:h;return _react.default.createElement(_react.default.Fragment,null,l&&_react.default.createElement("div",{className:c(k.searchBar)},_react.default.createElement("div",{className:c(k.searchBox)},_react.default.createElement(_Input.default,{name:"search",label:"",placeholder:"Search",onChange:this.handleSearch,compact:!0,value:o})),_react.default.createElement(_Text.default,{small:!0},"Showing ",p.length,"/",d.length," rows")),_react.default.createElement("div",{className:c(k.container)},_react.default.createElement(_DataTable.default,{data:p,keys:s,columnMetadata:r,zebra:!0,dynamicRowHeight:!0,rowHeight:"micro",renderers:q,height:u,width:Math.max(t.totalWidth,i),sortByValue:function convertToLowerCase(a,b){var c=a.data;return"string"==typeof c[b]?c[b].toLowerCase():c[b]}})))},b}(_react.default.PureComponent);_defineProperty(TableVis,"propTypes",{data:_propTypes.default.arrayOf(_propTypes.default.any).isRequired,height:_propTypes.default.number.isRequired,width:_propTypes.default.number.isRequired,alignPositiveNegative:_propTypes.default.bool,colorPositiveNegative:_propTypes.default.bool,columns:_propTypes.default.arrayOf(_propTypes.default.any).isRequired,filters:_propTypes.default.objectOf(_propTypes.default.arrayOf(_propTypes.default.any)),includeSearch:_propTypes.default.bool,onAddFilter:_propTypes.default.func,onRemoveFilter:_propTypes.default.func,tableFilter:_propTypes.default.bool.isRequired}),_defineProperty(TableVis,"defaultProps",defaultProps),_defineProperty(TableVis,"getDerivedStateFromProps",function(a,b){var c=a.filters,d=b.selectedCells,e=b.filters;if(e!==c){var f=new Set(Array.from(d));return Object.keys(c).forEach(function(a){c[a].forEach(function(b){f.add(getCellHash({key:a,value:b}))})}),_extends({},b,{filters:c,selectedCells:f})}return b});var _default=(0,_withStyles.default)(function(a){var b=a.unit;return{container:{display:"grid",overflowX:"scroll"},searchBar:{alignItems:"baseline",display:"flex",flexDirection:"row-reverse",flexGrow:0,marginBottom:b},searchBox:{marginLeft:b,// eslint-disable-next-line no-magic-numbers
width:25*b}}})(TableVis);exports.default=_default;