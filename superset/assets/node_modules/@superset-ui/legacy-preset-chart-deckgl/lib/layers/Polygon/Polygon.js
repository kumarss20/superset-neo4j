"use strict";exports.__esModule=!0,exports.getLayer=getLayer,exports.default=void 0;var _react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_deck=require("deck.gl"),_AnimatableDeckGLContainer=_interopRequireDefault(require("../../AnimatableDeckGLContainer")),_Legend=_interopRequireDefault(require("../../components/Legend")),_TooltipRow=_interopRequireDefault(require("../../TooltipRow")),_utils=require("../../utils"),_common=require("../common"),_time=require("../../utils/time"),_sandbox=_interopRequireDefault(require("../../utils/sandbox"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _inheritsLoose(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.__proto__=b}function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}var DOUBLE_CLICK_TRESHOLD=250;// milliseconds
function getPoints(a){return a.map(function(a){return a.polygon}).flat()}function _getElevation(a,b){/* in deck.gl 5.3.4 (used in Superset as of 2018-10-24), if a polygon has
   * opacity zero it will make everything behind it have opacity zero,
   * effectively showing the map layer no matter what other polygons are
   * behind it.
   */return 0===b(a)[3]?0:a.elevation}function setTooltipContent(a){return function(b){var c=a.metric.label||a.metric;return _react.default.createElement("div",{className:"deckgl-tooltip"},_react.default.createElement(_TooltipRow.default,{label:a.line_column+": ",value:""+b.object[a.line_column]}),a.metric&&_react.default.createElement(_TooltipRow.default,{label:c+": ",value:""+b.object[c]}))}}function getLayer(a,b,c,d,e,f,g){var h=a,i=h.fill_color_picker,j=h.stroke_color_picker,k=[].concat(b.data.features);if(null!=g&&g.forEach(function(a){k=k.filter(a)}),h.js_data_mutator){// Applying user defined data mutator if defined
var p=(0,_sandbox.default)(h.js_data_mutator);k=p(k)}var l=h.metric?h.metric.label||h.metric:null,m=null===h.metric?function(){return[i.r,i.g,i.b,255*i.a]}:(0,_utils.getBreakPointColorScaler)(h,k,function accessor(a){return a[l]}),n=function(a){var b=m(a);return 0<e.length&&-1===e.indexOf(a[h.line_column])&&(b[3]/=2),b},o=h.line_column&&h.metric&&0<=["geohash","zipcode"].indexOf(h.line_type)?setTooltipContent(h):void 0;return new _deck.PolygonLayer(_extends({id:"path-layer-"+h.slice_id,data:k,pickable:!0,filled:h.filled,stroked:h.stroked,getPolygon:function getPolygon(a){return a.polygon},getFillColor:n,getLineColor:[j.r,j.g,j.b,255*j.a],getLineWidth:h.line_width,extruded:h.extruded,getElevation:function getElevation(a){return _getElevation(a,n)},elevationScale:h.multiplier,fp64:!0},(0,_common.commonLayerProps)(h,d,o,f)))}var propTypes={formData:_propTypes.default.object.isRequired,payload:_propTypes.default.object.isRequired,setControlValue:_propTypes.default.func.isRequired,viewport:_propTypes.default.object.isRequired,onAddFilter:_propTypes.default.func,setTooltip:_propTypes.default.func},defaultProps={onAddFilter:function onAddFilter(){},setTooltip:function setTooltip(){}},DeckGLPolygon=/*#__PURE__*/function(a){function b(c){var d;return d=a.call(this,c)||this,d.state=b.getDerivedStateFromProps(c),d.getLayers=d.getLayers.bind(_assertThisInitialized(d)),d.onSelect=d.onSelect.bind(_assertThisInitialized(d)),d.onValuesChange=d.onValuesChange.bind(_assertThisInitialized(d)),d.onViewportChange=d.onViewportChange.bind(_assertThisInitialized(d)),d}_inheritsLoose(b,a),b.getDerivedStateFromProps=function getDerivedStateFromProps(a,b){// the state is computed only from the payload; if it hasn't changed, do
// not recompute state since this would reset selections and/or the play
// slider position due to changes in form controls
if(b&&a.payload.form_data===b.formData)return null;var c=a.payload.data.features||[],d=c.map(function(a){return a.__timestamp}),e=a.payload.form_data.time_grain_sqla||a.payload.form_data.granularity||"P1D",f=(0,_time.getPlaySliderParams)(d,e),g=f.start,h=f.end,i=f.getStep,j=f.values,k=f.disabled,l=a.formData.autozoom?(0,_common.fitViewport)(a.viewport,getPoints(c)):a.viewport;return{start:g,end:h,getStep:i,values:j,disabled:k,viewport:l,selected:[],lastClick:0,formData:a.payload.form_data}};var c=b.prototype;return c.onSelect=function onSelect(a){var b=this.props,c=b.formData,d=b.onAddFilter,e=new Date,f=e-this.state.lastClick<=DOUBLE_CLICK_TRESHOLD,g=[].concat(this.state.selected);if(f)g.splice(0,g.length,a);else if(c.toggle_polygons){var h=g.indexOf(a);-1===h?g.push(a):g.splice(h,1)}else g.splice(0,1,a);this.setState({selected:g,lastClick:e}),c.table_filter&&d(c.line_column,g,!1,!0)},c.onValuesChange=function onValuesChange(a){this.setState({values:Array.isArray(a)?a:[a,a+this.state.getStep(a)]})},c.onViewportChange=function onViewportChange(a){this.setState({viewport:a})},c.getLayers=function getLayers(a){if(void 0===this.props.payload.data.features)return[];var b=[];// time filter
a[0]===a[1]||a[1]===this.end?b.push(function(b){return b.__timestamp>=a[0]&&b.__timestamp<=a[1]}):b.push(function(b){return b.__timestamp>=a[0]&&b.__timestamp<a[1]});var c=getLayer(this.props.formData,this.props.payload,this.props.onAddFilter,this.props.setTooltip,this.state.selected,this.onSelect,b);return[c]},c.render=function render(){var a=this.props,b=a.payload,c=a.formData,d=a.setControlValue,e=this.state,f=e.start,g=e.end,h=e.getStep,i=e.values,j=e.disabled,k=e.viewport,l=c,m=l.metric?l.metric.label||l.metric:null,n=(0,_utils.getBuckets)(c,b.data.features,function accessor(a){return a[m]});return _react.default.createElement("div",{style:{position:"relative"}},_react.default.createElement(_AnimatableDeckGLContainer.default,{getLayers:this.getLayers,start:f,end:g,getStep:h,values:i,onValuesChange:this.onValuesChange,disabled:j,viewport:k,onViewportChange:this.onViewportChange,mapboxApiAccessToken:b.data.mapboxApiKey,mapStyle:c.mapbox_style,setControlValue:d,aggregation:!0},null!==c.metric&&_react.default.createElement(_Legend.default,{categories:n,position:c.legend_position,format:c.legend_format})))},b}(_react.default.Component);DeckGLPolygon.propTypes=propTypes,DeckGLPolygon.defaultProps=defaultProps;var _default=DeckGLPolygon;exports.default=_default;