/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */ /* eslint-disable sort-keys, func-names, babel/no-invalid-this, no-plusplus, no-magic-numbers */import d3 from"d3";import PropTypes from"prop-types";import"d3-svg-legend";import d3tip from"d3-tip";import{getSequentialSchemeRegistry}from"@superset-ui/color";import{getNumberFormatter,NumberFormats}from"@superset-ui/number-format";import"./vendor/d3tip.css";import"./Heatmap.css";var propTypes={data:PropTypes.shape({records:PropTypes.arrayOf(PropTypes.shape({x:PropTypes.string,y:PropTypes.string,v:PropTypes.number,perc:PropTypes.number,rank:PropTypes.number})),extents:PropTypes.arrayOf(PropTypes.number)}),width:PropTypes.number,height:PropTypes.number,bottomMargin:PropTypes.oneOfType([PropTypes.string,PropTypes.number]),colorScheme:PropTypes.string,columnX:PropTypes.string,columnY:PropTypes.string,leftMargin:PropTypes.oneOfType([PropTypes.string,PropTypes.number]),metric:PropTypes.oneOfType([PropTypes.string,PropTypes.object]),normalized:PropTypes.bool,numberFormat:PropTypes.string,showLegend:PropTypes.bool,showPercentage:PropTypes.bool,showValues:PropTypes.bool,sortXAxis:PropTypes.string,sortYAxis:PropTypes.string,xScaleInterval:PropTypes.number,yScaleInterval:PropTypes.number,yAxisBounds:PropTypes.arrayOf(PropTypes.number)};function cmp(c,a){return c>a?1:-1}// Inspired from http://bl.ocks.org/mbostock/3074470
// https://jsfiddle.net/cyril123/h0reyumq/
function Heatmap(a,b){// Dynamically adjusts  based on max x / y category lengths
function c(a,b,c){var e={},f={};z.forEach(function(b){e[b[a]]=(e[b[a]]||0)+b.v,f[b[a]]=b[a]});// Not usgin object.keys() as it converts to strings
var g=Object.keys(f).map(function(a){return f[a]});return"alpha_asc"===c?e=g.sort(cmp):"alpha_desc"===c?e=g.sort(cmp).reverse():"value_desc"===c?e=Object.keys(e).sort(function(c,a){return e[c]>e[a]?-1:1}):"value_asc"==c&&(e=Object.keys(e).sort(function(c,a){return e[a]>e[c]?-1:1})),"y"===a&&b&&e.reverse(),b?d3.scale.ordinal().domain(e).rangeBands(b):d3.scale.ordinal().domain(e).range(d3.range(e.length))}// eslint-disable-next-line no-param-reassign
var d=b.data,e=b.width,f=b.height,g=b.bottomMargin,h=b.canvasImageRendering,i=b.colorScheme,j=b.columnX,k=b.columnY,l=b.leftMargin,o=b.metric,p=b.normalized,q=b.numberFormat,r=b.showLegend,s=b.showPercentage,t=b.showValues,u=b.sortXAxis,v=b.sortYAxis,w=b.xScaleInterval,x=b.yScaleInterval,y=b.yAxisBounds,z=d.records,A=d.extents,B={top:10,right:10,bottom:35,left:35},C=getNumberFormatter(q);a.innerHTML="";var D={};(function(){for(var a,b=4.5,c=6,d=1,e=1,f=0;f<z.length;f++)a=z[f],d=Math.max(d,a.x&&a.x.toString().length||1),e=Math.max(e,a.y&&a.y.toString().length||1);B.left="auto"===l?Math.ceil(Math.max(B.left,c*e)):l,r&&(B.right+=40),B.bottom="auto"===g?Math.ceil(Math.max(B.bottom,b*d)):g})();var E=e-(B.left+B.right),F=f-(B.bottom+B.top),G=getNumberFormatter(NumberFormats.PERCENT),m=c("x",null,u),n=c("y",null,v),H=c("x",[0,E],u),I=c("y",[F,0],v),J=0,K=1,L=[H.domain().length,I.domain().length],M=y[0]||0,N=y[1]||1,O=getSequentialSchemeRegistry().get(i).createLinearScale([M,N]),P=[d3.scale.linear().domain([0,L[J]]).range([0,E]),d3.scale.linear().domain([0,L[K]]).range([0,F])],Q=d3.select(a);Q.classed("superset-legacy-chart-heatmap",!0);var R=Q.append("canvas").attr("width",L[J]).attr("height",L[K]).style("width",E+"px").style("height",F+"px").style("image-rendering",h).style("left",B.left+"px").style("top",B.top+"px").style("position","absolute"),S=Q.append("svg").attr("width",e).attr("height",f).style("position","relative");if(t){var Y=S.selectAll("rect").data(z).enter().append("g").attr("transform","translate("+B.left+", "+B.top+")");Y.append("text").attr("transform",function(a){return"translate("+H(a.x)+", "+I(a.y)+")"}).attr("y",I.rangeBand()/2).attr("x",H.rangeBand()/2).attr("text-anchor","middle").attr("dy",".35em").text(function(a){return C(a.v)}).attr("font-size",Math.min(I.rangeBand(),H.rangeBand())/3+"px").attr("fill",function(a){return a.v>=A[1]/2?"white":"black"})}if(r){var Z=d3.legend.color().labelFormat(C).scale(O).shapePadding(0).cells(10).shapeWidth(10).shapeHeight(10).labelOffset(3);S.append("g").attr("transform","translate("+(e-40)+", "+B.top+")").call(Z)}var T=d3tip().attr("class","d3-tip").offset(function(){var a=d3.mouse(this),b=a[0]-E/2;return[a[1]-20,b]}).html(function(){var a="",b=d3.mouse(this),c=Math.floor(P[0].invert(b[0])),d=Math.floor(P[1].invert(b[1])),e="object"==typeof o?o.label:o;if(c in D&&d in D[c]){var f=D[c][d];a+="<div><b>"+j+": </b>"+f.x+"<div>",a+="<div><b>"+k+": </b>"+f.y+"<div>",a+="<div><b>"+e+": </b>"+C(f.v)+"<div>",s&&(a+="<div><b>%: </b>"+G(p?f.rank:f.perc)+"<div>"),T.style("display",null)}else// this is a hack to hide the tooltip because we have map it to a single <rect>
// d3-tip toggles opacity and calling hide here is undone by the lib after this call
T.style("display","none");return a}),U=S.append("g").attr("transform","translate("+B.left+", "+B.top+")").append("rect").classed("background-rect",!0).on("mousemove",T.show).on("mouseout",T.hide).attr("width",E).attr("height",F);U.call(T);var V=d3.svg.axis().scale(H).outerTickSize(0).tickValues(H.domain().filter(function(a,b){return!(b%w)})).orient("bottom"),W=d3.svg.axis().scale(I).outerTickSize(0).tickValues(I.domain().filter(function(a,b){return!(b%x)})).orient("left");S.append("g").attr("class","x axis").attr("transform","translate("+B.left+","+(B.top+F)+")").call(V).selectAll("text").attr("x",-4).attr("y",10).attr("dy","0.3em").style("text-anchor","end").attr("transform","rotate(-45)"),S.append("g").attr("class","y axis").attr("transform","translate("+B.left+","+B.top+")").call(W);var X=R.node().getContext("2d");X.imageSmoothingEnabled=!1,// Compute the pixel colors; scaled by CSS.
function(){var a=new Image,b=X.createImageData(L[0],L[1]),e={};z.forEach(function(a){var b=d3.rgb(O(p?a.rank:a.perc)),c=m(a.x),d=n(a.y);e[c+d*m.domain().length]=b,D[c]===void 0&&(D[c]={}),D[c][d]===void 0&&(D[c][d]=a)});for(var f=-1,d=0;d<L[0]*L[1];d++){var g=e[d],h=255;g===void 0&&(g=d3.rgb("#F00"),h=0),b.data[++f]=g.r,b.data[++f]=g.g,b.data[++f]=g.b,b.data[++f]=h}X.putImageData(b,0,0),a.src=R.node().toDataURL()}()}Heatmap.displayName="Heatmap",Heatmap.propTypes=propTypes;export default Heatmap;