!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("d3-dsv"),require("topojson-client"),require("d3-time-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","d3-dsv","topojson-client","d3-time-format"],t):t((e=e||self).vega={},e.vega,e.d3,e.topojson,e.d3)}(this,function(e,t,n,r,o){"use strict";var i=/^([A-Za-z]+:)?\/\//,s="file://";async function u(e,t){const n=await this.sanitize(e,t),r=n.href;return n.localFile?this.file(r):this.http(r,t)}async function f(e,n){n=t.extend({},this.options,n);const r=this.fileAccess,o={href:null};let u,f,a,c;return null!=e&&"string"==typeof e||t.error("Sanitize failure, invalid URI: "+t.stringValue(e)),f=i.test(e),(c=n.baseURL)&&!f&&(e.startsWith("/")||"/"===c[c.length-1]||(e="/"+e),e=c+e),a=(u=e.startsWith(s))||"file"===n.mode||"http"!==n.mode&&!f&&r,u?e=e.slice(s.length):e.startsWith("//")&&("file"===n.defaultProtocol?(e=e.slice(2),a=!0):e=(n.defaultProtocol||"http")+":"+e),Object.defineProperty(o,"localFile",{value:!!a}),o.href=e,n.target&&(o.target=n.target+""),n.rel&&(o.rel=n.rel+""),o}function a(e){return e?function(t){return new Promise(function(n,r){e.readFile(t,function(e,t){e?r(e):n(t)})})}:c}async function c(){t.error("No file system access.")}function l(e){return e?async function(n,r){const o=t.extend({},this.options.http,r),i=r&&r.response,s=await e(n,o);return s.ok?t.isFunction(s[i])?s[i]():s.text():t.error(s.status+""+s.statusText)}:p}async function p(){t.error("No HTTP fetch method available.")}var d={boolean:t.toBoolean,integer:t.toNumber,number:t.toNumber,date:t.toDate,string:t.toString,unknown:t.identity},h=[function(e){return"true"===e||"false"===e||!0===e||!1===e},function(e){return v(e)&&(e=+e)==~~e},v,function(e){return!isNaN(Date.parse(e))}],y=["boolean","integer","number","date"];function m(e,t){if(!e||!e.length)return"unknown";var n,r,o,i,s=0,u=e.length,f=h.length,a=h.map(function(e,t){return t+1});for(r=0,u=e.length;r<u;++r)for(n=t?e[r][t]:e[r],o=0;o<f;++o)if(a[o]&&(null!=(i=n)&&i==i)&&!h[o](n)&&(a[o]=0,++s===h.length))return"string";return s=a.reduce(function(e,t){return 0===e?t:e},0)-1,y[s]}function g(e,t){return t.reduce(function(t,n){return t[n]=m(e,n),t},{})}function v(e){return!(isNaN(+e)||e instanceof Date)}function j(e){const n=function(n,r){const o={delimiter:e};return b(n,r?t.extend(r,o):o)};return n.responseType="text",n}function b(e,r){return r.header&&(e=r.header.map(t.stringValue).join(r.delimiter)+"\n"+e),n.dsvFormat(r.delimiter).parse(e+"")}function x(e,n){const r=n&&n.property?t.field(n.property):t.identity;return!t.isObject(e)||(o=e,"function"==typeof Buffer&&t.isFunction(Buffer.isBuffer)&&Buffer.isBuffer(o))?r(JSON.parse(e)):function(e,t){return t&&t.copy?JSON.parse(JSON.stringify(e)):e}(r(e));var o}b.responseType="text",x.responseType="json";const O={interior:(e,t)=>e!==t,exterior:(e,t)=>e===t};function N(e,n){let o,i,s,u;return e=x(e,n),n&&n.feature?(o=r.feature,s=n.feature):n&&n.mesh?(o=r.mesh,s=n.mesh,u=O[n.filter]):t.error("Missing TopoJSON feature or mesh parameter."),(i=(i=e.objects[s])?o(e,i,u):t.error("Invalid TopoJSON object: "+s))&&i.features||[i]}N.responseType="json";const T={dsv:b,csv:j(","),tsv:j("\t"),json:x,topojson:N};function P(e,t){return arguments.length>1?(T[e]=t,this):T.hasOwnProperty(e)?T[e]:null}var w=function(e,t){return function(n){return{options:n||{},sanitize:f,load:u,fileAccess:!!t,file:a(t),http:l(e)}}}("undefined"!=typeof fetch&&fetch,null);e.format=T,e.formats=P,e.inferType=m,e.inferTypes=g,e.loader=w,e.read=function(e,n,r){const i=P((n=n||{}).type||"json");return i||t.error("Unknown data format type: "+n.type),e=i(e,n),n.parse&&function(e,t,n){if(e.length){n=n||o.timeParse;var r,i,s,u,f,a,c,l=e.columns||Object.keys(e[0]);for("auto"===t&&(t=g(e,l)),l=Object.keys(t),r=l.map(function(e){var r,i,s=t[e];if(s&&(0===s.indexOf("date:")||0===s.indexOf("utc:")))return("'"===(i=(r=s.split(/:(.+)?/,2))[1])[0]&&"'"===i[i.length-1]||'"'===i[0]&&'"'===i[i.length-1])&&(i=i.slice(1,-1)),"utc"===r[0]?o.utcParse(i):n(i);if(!d[s])throw Error("Illegal format pattern: "+e+":"+s);return d[s]}),u=0,a=e.length,c=l.length;u<a;++u)for(i=e[u],f=0;f<c;++f)s=l[f],i[s]=r[f](i[s])}}(e,n.parse,r),e.hasOwnProperty("columns")&&delete e.columns,e},e.responseType=function(e){const t=P(e);return t&&t.responseType||"text"},e.typeParsers=d,Object.defineProperty(e,"__esModule",{value:!0})});